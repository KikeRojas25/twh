
<div class="flex flex-col flex-auto min-w-0">


  <div class="flex flex-col sm:flex-row flex-0 sm:items-center sm:justify-between p-6 sm:py-8 sm:px-10 border-b bg-card dark:bg-transparent">
    <div class="flex-1 min-w-0">
      <div  class="flex flex-wrap items-center font-medium">
        <div>
          <a  class="whitespace-nowrap text-primary-500">TWH</a>
        </div>
        <div class="flex items-center ml-1 whitespace-nowrap">
              <mat-icon
              class="fuse-horizontal-navigation-item-icon"
              [svgIcon]="'heroicons_solid:chevron-right'"></mat-icon>
              <a  class="ml-1 text-primary-500">Listado de ORI</a>
          </div>
      </div>
          <div class="mt-2"><h2  class="text-3xl md:text-4xl font-extrabold tracking-tight leading-7 sm:leading-10 truncate">  Equipos de transporte   </h2>
      </div>
  </div>
  </div>


 
  <div class="grid grid-cols-1 sm:grid-cols-4 gap-6 p-6 sm:py-8 sm:px-10 border-b bg-card dark:bg-transparent">
  
    <div class="flex flex-col">
      <label class="block text-lg font-semibold text-gray-800 dark:text-gray-200">Almacén</label>
      <p-dropdown [options]="almacenes" [(ngModel)]="model.AlmacenId" 
      [style]="{'width': '100%'}" 
      [resetFilterOnHide]="true"
      [hideTransitionOptions]="'0ms'"
      [showTransitionOptions]="'0ms'"
      [filter]="true"
      filterBy="label" 
      [showClear]="true" 
      placeholder="Selecciona un almacén" class="w-60">

        <ng-template let-item pTemplate="selectedItem">
          <span style="vertical-align:left;">{{item.label}}</span>
      </ng-template>

      </p-dropdown>
    </div>


  <!-- OC Field -->
  <div class="flex flex-col">
    <label class="block text-lg font-semibold text-gray-800 dark:text-gray-200">Propietario</label>

      <p-dropdown name="clientes" 
      [options]="clientes" 
      [resetFilterOnHide]="true"
      [(ngModel)]="model.PropietarioId" 
      [filter]="true"
      filterBy="label" 
      [showClear]="true" 
      [style]="{'width': '100%'}" 
      [hideTransitionOptions]="'0ms'"
      [showTransitionOptions]="'0ms'"
         placeholder="Selecciona un propietario" 
        >
        <ng-template let-item pTemplate="selectedItem">
          <span style="vertical-align:left;">{{item.label}}</span>
      </ng-template>

      
      </p-dropdown>
  </div>
  <div class="flex flex-col">
    <label class="block text-lg font-semibold text-gray-800 dark:text-gray-200">Estado</label>
      <p-dropdown [options]="estados"  [(ngModel)]="model.EstadoId"
      scrollHeight="40vh" class="input-form-field  col-sm-5"    [style]="{'width':'100%'}"  [resetFilterOnHide]="true"
      [hideTransitionOptions]="'0ms'"
      [showTransitionOptions]="'0ms'"
      placeholder="Todos"
      filter="false">
          <ng-template let-item pTemplate="selectedItem">
              <span style="vertical-align:middle;">{{item.label}}</span>
          </ng-template>
      </p-dropdown>
  </div>

  


  <div class="flex flex-col">
    <p-button severity="primary" icon="fa fa-search" label="Buscar" (onClick)="buscar()" > </p-button>

  </div> 

 




</div>
    <!-- Buscar Button -->
   

  
  <div class="flex flex-col p-6 sm:py-8 sm:px-10 border-b bg-card dark:bg-transparent">

  
        <p-table [style]="{width:'100%'}"
           [scrollable]="true" [columns]="cols" [value]="transportes"
             #dt [paginator]="true"
           [rows]="40" [resizableColumns]="true"  [responsive]="true"  >

             <ng-template pTemplate="colgroup" let-columns>
               <colgroup>
                   <col *ngFor="let col of columns"   [ngStyle]="{'width': col.width}" >
               </colgroup>
           </ng-template>
             <ng-template pTemplate="header" let-columns>
               <tr>
                   <th  [ngStyle]="{'width': col.width}" *ngFor="let col of columns" pResizableColumn [pSortableColumn]="col.field">
                       {{col.header}}
                       <p-sortIcon [field]="col.field" ariaLabel="Activate to sort" ariaLabelDesc="Activate to sort in descending order" ariaLabelAsc="Activate to sort in ascending order"></p-sortIcon>
                   </th>
               </tr>
           </ng-template>
             <ng-template pTemplate="body" let-rowData let-columns="columns">
               <tr  [pSelectableRow]="rowData">
                   <td class="ui-resizable-column">
                     <div class="ui-inputgroup">
                      <button [disabled]="rowData.estado == 'Cerrado' || rowData.estado == 'Asignado'" class="btn btn-space btn-outline-primary" pTooltip="Asignar Puerta" tooltipPosition="top" (click)="openDoor(rowData.id, rowData.almacenId)" type="button"><i class="pi pi-building"></i></button>
                      <button [disabled]="rowData.estado == 'Cerrado' || rowData.estado == 'Llegada'" class="btn btn-space btn-outline-primary" pTooltip="Descargar Mercadería" tooltipPosition="top" (click)="openEquipoTransporte(rowData.id)" type="button"><i class="pi pi-box"></i></button>
                     </div>
                 </td>

                 <td class="ui-resizable-column"> {{rowData.placa  }} </td>
                 <td class="ui-resizable-column"> {{rowData.marca  }}  </td>
                 <td class="ui-resizable-column"> {{rowData.tipoVehiculo  }}  </td>
                 <td class="ui-resizable-column"> {{rowData.equipoTransporte  }}</td>
                 <td class="ui-resizable-column"> {{rowData.puerta}} </td>



                   <td  [ngClass]="rowData.estado == 'Llegada' ? 'old-car'
                   :  (rowData.estado == 'Asignado'?' very-old-car': null) "> {{rowData.estado}}</td>

               </tr>
               </ng-template>

           </p-table>

</div>





<p-confirmDialog />
<p-toast />

<!-- Modal Asignar Puerta -->
<p-dialog 
  [(visible)]="displayAsignarPuertaDialog" 
  [modal]="true" 
  [style]="{width: '600px'}"
  [closable]="true"
  [draggable]="false"
  [resizable]="false"
  header="Asignar Puerta"
  (onHide)="displayAsignarPuertaDialog = false">
  
  <div class="p-4">
    <p class="mb-4 text-gray-600">Seleccione una puerta disponible para asignar al equipo de transporte:</p>
    
    <p-table 
      [value]="puertas" 
      [loading]="loadingPuertas"
      [responsiveLayout]="'scroll'"
      styleClass="p-datatable-sm"
      [paginator]="true"
      [rows]="10">
      
      <ng-template pTemplate="header">
        <tr>
          <th pSortableColumn="ubicacion">
            Ubicación <p-sortIcon field="ubicacion"></p-sortIcon>
          </th>
        
          <th pSortableColumn="estado">
            Estado <p-sortIcon field="estado"></p-sortIcon>
          </th>
          <th>Acciones</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-row>
        <tr>
          <td>{{ row.nombre }}</td>

          <td>
            <span [ngClass]="row.nombreEstado == 'Libre' ? 'text-green-600 font-semibold' : 'text-gray-500'">
              {{ row.nombreEstado }}
            </span>
          </td>
          <td>
            <p-button
              *ngIf="row.nombreEstado == 'Libre'"
              icon="pi pi-check"
              severity="success"
              [outlined]="true"
              pTooltip="Asignar esta puerta"
              tooltipPosition="top"
              (onClick)="asignarPuerta(row.id)"
              [loading]="loadingPuertas">
            </p-button>
            <span *ngIf="row.nombreEstado != 'Libre'" class="text-gray-400 text-sm">No disponible</span>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="5" class="text-center text-gray-500 py-4">
            No hay puertas disponibles para este almacén.
          </td>
        </tr>
      </ng-template>

    </p-table>
  </div>

  <ng-template pTemplate="footer">
    <p-button 
      label="Cerrar" 
      icon="pi pi-times" 
      [text]="true"
      (onClick)="displayAsignarPuertaDialog = false">
    </p-button>
  </ng-template>

</p-dialog>

<!-- Modal Órdenes de Recibo -->
<p-dialog 
  [(visible)]="displayOrdenesReciboDialog" 
  [modal]="true" 
  [style]="{width: '90vw', maxWidth: '1200px'}"
  [closable]="true"
  [draggable]="false"
  [resizable]="true"
  header="Órdenes de Recibo por Equipo de Transporte"
  (onHide)="displayOrdenesReciboDialog = false">
  
  <div class="p-4">
    <div class="mb-4" *ngIf="equipoTransporteSeleccionado">
      <p class="text-lg font-semibold text-gray-700">
        Equipo de Transporte: <span class="text-primary-600">{{ equipoTransporteSeleccionado }}</span>
      </p>
    </div>
    
    <p-table 
      [value]="ordenesRecibo" 
      [loading]="loadingOrdenesRecibo"
      [columns]="colsOrdenes"
      [scrollable]="true"
      scrollHeight="500px"
      [paginator]="true"
      [rows]="10"
      styleClass="p-datatable-sm">
      
      <ng-template pTemplate="colgroup" let-columns>
        <colgroup>
          <col *ngFor="let col of columns" [ngStyle]="{'width': col.width}">
        </colgroup>
      </ng-template>

      <ng-template pTemplate="header" let-columns>
        <tr>
          <th *ngFor="let col of columns" [ngStyle]="{'width': col.width}">
            {{ col.header }}
          </th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-row let-columns="columns">
        <tr>
          <td>
            <div class="flex gap-2">
              <p-button 
                [disabled]="row.nombreEstado == 'Almacenado' || row.nombreEstado == 'Pendiente Acomodo' || row.nombreEstado == 'Pendiente Almacenamiento'"
                icon="pi pi-sign-in" 
                [outlined]="true"
                severity="primary"
                pTooltip="Iniciar recibo múltiple" 
                tooltipPosition="top"
                (onClick)="identificarMultiple(row.ordenReciboId)"
                [style]="{'width': 'auto', 'height': '2rem'}">
              </p-button>
              <p-button 
                [disabled]="row.nombreEstado == 'Almacenado' || row.nombreEstado == 'Recibiendo' || row.nombreEstado == 'Pendiente Almacenamiento' || row.nombreEstado == 'Asignado'"
                icon="pi pi-th-large" 
                [outlined]="true"
                severity="primary"
                pTooltip="Acomodo" 
                tooltipPosition="top"
                (onClick)="acomodo(row.ordenReciboId)"
                [style]="{'width': 'auto', 'height': '2rem'}">
              </p-button>
              <p-button 
                [disabled]="row.nombreEstado == 'Almacenado' || row.nombreEstado == 'Pendiente Acomodo' || row.nombreEstado == 'Recibiendo' || row.nombreEstado == 'Asignado'"
                icon="pi pi-building" 
                [outlined]="true"
                severity="primary"
                pTooltip="Almacenamiento" 
                tooltipPosition="top"
                (onClick)="almacenar(row.ordenReciboId)"
                [style]="{'width': 'auto', 'height': '2rem'}">
              </p-button>
            </div>
          </td>
          <td>
            <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-sm font-semibold">
              {{ row.numOrden }}
            </span>
          </td>
          <td>{{ row.almacen || row.Almacen }}</td>
          <td>{{ row.propietario }}</td>
          <td>
            <span [ngClass]="getEstadoClass(row.nombreEstado)" class="px-2 py-1 rounded text-sm font-semibold">
              {{ row.nombreEstado }}
            </span>
          </td>
          <td>{{ row.ubicacion || '-' }}</td>
          <td>{{ row.fechaRegistro | date:'dd-MM-yyyy' }}</td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td [attr.colspan]="colsOrdenes.length" class="text-center text-gray-500 py-4">
            No hay órdenes de recibo para este equipo de transporte.
          </td>
        </tr>
      </ng-template>

    </p-table>
  </div>

  <ng-template pTemplate="footer">
    <p-button 
      label="Cerrar" 
      icon="pi pi-times" 
      [text]="true"
      (onClick)="displayOrdenesReciboDialog = false">
    </p-button>
  </ng-template>

</p-dialog>





