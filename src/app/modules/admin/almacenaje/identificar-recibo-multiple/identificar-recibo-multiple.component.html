<div class="flex flex-col flex-auto min-w-0 bg-gray-50">
  <!-- Header -->
  <div class="flex flex-col sm:flex-row flex-0 sm:items-center sm:justify-between p-6 sm:py-4 sm:px-10 border-b border-gray-200 bg-white shadow-sm">
    <div class="flex-1 min-w-0">
      <div class="flex flex-wrap items-center font-medium text-sm text-gray-600">
        <div>
          <a class="whitespace-nowrap text-gray-700 hover:text-gray-900">TWH</a>
        </div>
        <div class="flex items-center ml-1 whitespace-nowrap">
          <mat-icon class="fuse-horizontal-navigation-item-icon text-gray-400" [svgIcon]="'heroicons_solid:chevron-right'"></mat-icon>
          <a class="ml-1 text-gray-700 hover:text-gray-900">Almacenaje</a>
        </div>
        <div class="flex items-center ml-1 whitespace-nowrap">
          <mat-icon class="fuse-horizontal-navigation-item-icon text-gray-400" [svgIcon]="'heroicons_solid:chevron-right'"></mat-icon>
          <a class="ml-1 text-gray-700 hover:text-gray-900">Identificar Recibo Múltiple</a>
        </div>
      </div>
      <div class="mt-1">
        <h2 class="text-3xl md:text-4xl font-semibold tracking-tight leading-7 sm:leading-10 truncate text-gray-900">
          Identificar Recibo Múltiple
        </h2>
      </div>
    </div>
    <div class="flex items-center gap-2 mt-4 sm:mt-0">
      <button
        class="px-4 py-2 text-sm font-medium text-white bg-gray-700 hover:bg-gray-600 rounded-md shadow-sm transition-all duration-150"
        pButton
        icon="pi pi-check"
        label="Terminar"
        iconPos="left"
        [loading]="loading"
        (onClick)="terminarIdentificacion()">
      </button>
      <button
        class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 hover:bg-gray-50 rounded-md shadow-sm transition-all duration-150"
        pButton
        icon="pi pi-arrow-left"
        label="Regresar"
        iconPos="left"
        (onClick)="regresar()">
      </button>
    </div>
  </div>

  <div class="flex flex-col p-6">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Columna Izquierda -->
      <div class="flex flex-col gap-6">
        <!-- Paso 1: Líneas de Orden (Compacta) -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
      <div class="bg-gray-800 text-white px-4 py-2.5 border-b border-gray-700">
        <h3 class="text-base font-semibold text-gray-100">Paso 1: Seleccionar Línea de Orden</h3>
        <p class="text-xs text-amber-300 mt-1">Seleccione una línea de la orden para identificar productos</p>
      </div>
      <div class="p-4">
        <p-table 
          [value]="ordenDetalles" 
          [loading]="loading"
          [columns]="colsDetalles"
          [scrollable]="true"
          scrollHeight="250px"
          [paginator]="true"
          [rows]="5"
          selectionMode="single"
          (onRowSelect)="identificar($event)"
          styleClass="p-datatable-sm">
          
          <ng-template pTemplate="colgroup" let-columns>
            <colgroup>
              <col *ngFor="let col of columns" [ngStyle]="{'width': col.width}">
            </colgroup>
          </ng-template>

          <ng-template pTemplate="header" let-columns>
            <tr class="bg-gray-800 text-white">
              <th *ngFor="let col of columns" [ngStyle]="{'width': col.width}" class="text-center px-4 py-2 text-sm font-semibold text-white border-b border-gray-700">
                {{ col.header }}
              </th>
            </tr>
          </ng-template>

          <ng-template pTemplate="body" let-row let-columns="columns">
            <tr [pSelectableRow]="row" class="border-b border-gray-100 hover:bg-gray-50 transition-colors duration-150">
              <td class="text-center px-4 py-2 text-gray-700 text-sm">{{ row.linea }}</td>
              <td class="text-center px-4 py-2 text-gray-700 text-sm">{{ getCodigo(row) }}</td>
              <td class="text-center px-4 py-2 text-gray-700 text-sm">{{ row.producto }}</td>
              <td class="text-center px-4 py-2 text-amber-700 text-sm font-medium">{{ row.cantidad }}</td>
              <td class="text-center px-4 py-2">
                <span *ngIf="estaCompleto(row)">
                  <i class="pi pi-check text-green-600"></i>
                </span>
                <span *ngIf="!estaCompleto(row)" class="text-amber-700 font-medium">
                  {{ calcularPendiente(row) }}
                </span>
              </td>
              <td class="text-center px-4 py-2 text-gray-700 text-sm">{{ row.cantidadFaltante || 0 }}</td>
              <td class="text-center px-4 py-2">
                <span [ngClass]="estaCompleto(row) ? 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800' : 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-800'">
                  {{ estaCompleto(row) ? 'Completo' : 'Pendiente' }}
                </span>
              </td>
            </tr>
          </ng-template>
        </p-table>
        </div>
        </div>
      </div>

      <!-- Columna Derecha -->
      <div class="flex flex-col gap-6">
        <!-- Paso 2: Formulario de Identificación -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
      <div class="bg-gray-800 text-white px-4 py-3 border-b border-gray-700">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-base font-semibold text-gray-100">Paso 2: Completar Datos del Producto</h3>
        </div>
        <div class="flex flex-wrap items-center gap-4 mt-2">
          <div class="flex items-center gap-2">
            <span class="text-xs text-gray-300 font-medium">Código:</span>
            <span class="text-sm text-white font-semibold bg-gray-700 px-2 py-1 rounded">{{ modelDetail.codigo || '-' }}</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-xs text-gray-300 font-medium">Producto:</span>
            <span class="text-sm text-white">{{ modelDetail.producto || 'Seleccione una línea de orden' }}</span>
          </div>
        </div>
      </div>
      <div class="p-3">
        <form #f="ngForm" (ngSubmit)="actualizar()">

          <!-- Información de Lote y Fechas -->
          <div class="mb-3 pb-2 border-b border-gray-200">
            <h4 class="text-xs font-semibold text-gray-900 mb-2">Información de Lote y Fechas</h4>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
              <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Lote</label>
                <input 
                  pInputText 
                  [(ngModel)]="modelDetail.LotNum" 
                  name="LotNum"
                  (blur)="onBlurLotNum(modelDetail.LotNum)"
                  class="w-full text-sm border-gray-300 focus:border-amber-500 focus:ring-amber-500"
                  styleClass="text-sm"
                  placeholder="Ingrese el lote">
              </div>
              <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Fecha Manufactura</label>
                <p-calendar 
                  [(ngModel)]="modelDetail.fechaManufactura" 
                  name="fechaManufactura"
                  [locale]="es"
                  dateFormat="dd/mm/yy"
                  class="w-full"
                  [styleClass]="'text-sm border-gray-300 focus:border-amber-500'">
                </p-calendar>
              </div>
              <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Fecha Expiración</label>
                <p-calendar 
                  [(ngModel)]="modelDetail.fechaExpire" 
                  name="fechaExpire"
                  [locale]="es"
                  dateFormat="dd/mm/yy"
                  class="w-full"
                  [styleClass]="'text-sm border-gray-300 focus:border-amber-500'">
                </p-calendar>
              </div>
            </div>
          </div>

          <!-- Información de Almacenamiento -->
          <div class="mb-3 pb-2 border-b border-gray-200">
            <h4 class="text-xs font-semibold text-gray-900 mb-2">Información de Almacenamiento</h4>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
              <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Estado <span class="text-red-500">*</span></label>
                <p-dropdown 
                  [options]="estados" 
                  [(ngModel)]="modelDetail.estadoId"
                  name="estadoId"
                  optionLabel="label"
                  optionValue="value"
                  placeholder="Seleccione un estado"
                  class="w-full"
                  [styleClass]="'text-sm border-gray-300 focus:border-amber-500'">
                  <ng-template let-item pTemplate="selectedItem">
                    <span>{{ item.label }}</span>
                  </ng-template>
                </p-dropdown>
              </div>
              <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Huella</label>
                <p-dropdown 
                  [options]="huellas" 
                  [(ngModel)]="modelDetail.huellaId"
                  name="huellaId"
                  (onChange)="onChangeHuella($event)"
                  placeholder="Seleccione una huella"
                  class="w-full"
                  [styleClass]="'text-sm border-gray-300 focus:border-amber-500'">
                </p-dropdown>
              </div>
              <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Peso (kg)</label>
                <p-inputNumber 
                  [(ngModel)]="modelDetail.peso" 
                  name="peso"
                  mode="decimal"
                  [min]="0"
                  [maxFractionDigits]="2"
                  class="w-full"
                  [styleClass]="'text-sm border-gray-300 focus:border-amber-500'">
                </p-inputNumber>
              </div>
            </div>
          </div>

          <!-- Información Adicional y Cantidad -->
          <div class="mb-3">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <div>
                <h4 class="text-xs font-semibold text-gray-900 mb-2">Información Adicional</h4>
                <div>
                  <label class="block text-xs font-medium text-gray-700 mb-1">Referencia</label>
                  <input 
                    pInputText 
                    [(ngModel)]="modelDetail.referencia" 
                    name="referencia"
                    maxlength="20"
                    class="w-full text-sm border-gray-300 focus:border-amber-500 focus:ring-amber-500"
                    styleClass="text-sm"
                    placeholder="Referencia opcional">
                </div>
              </div>
              <div>
                <h4 class="text-xs font-semibold text-gray-900 mb-2">Cantidad Recibida <span class="text-red-500">*</span></h4>
                <div class="bg-amber-50 border-2 border-amber-300 rounded-lg p-3">
                  <label class="block text-sm font-semibold text-amber-800 mb-2">Cantidad</label>
                  <p-inputNumber 
                    [(ngModel)]="modelDetail.untQty" 
                    name="untQty"
                    mode="decimal"
                    [min]="0"
                    class="w-full"
                    [styleClass]="'text-base font-bold border-amber-400 focus:border-amber-600 bg-white'">
                  </p-inputNumber>
                </div>
              </div>
            </div>
          </div>

          <!-- Botones de Acción -->
          <div class="flex flex-wrap gap-2 pt-2 border-t border-gray-200">
      
            <button
              class="px-3 py-1.5 text-xs font-medium text-white bg-gray-700 hover:bg-gray-600 rounded-md shadow-sm transition-all duration-150 disabled:opacity-50 disabled:cursor-not-allowed"
              pButton
              label="Generar automáticamente"
              icon="pi pi-box"
              iconPos="left"
              [disabled]="!f.valid"
              [loading]="loading"
              (onClick)="generarPallets()">
            </button>
            <button
              class="px-3 py-1.5 text-xs font-medium text-white bg-red-600 hover:bg-red-700 rounded-md shadow-sm transition-all duration-150 disabled:opacity-50 disabled:cursor-not-allowed"
              pButton
              label="Marcar como Faltante"
              icon="pi pi-exclamation-triangle"
              iconPos="left"
              [disabled]="!f.valid"
              [loading]="loading"
              (onClick)="agregarFaltantes()">
            </button>
            <button
            class="px-3 py-1.5 text-xs font-medium text-white bg-amber-600 hover:bg-amber-700 rounded-md shadow-sm transition-all duration-150 disabled:opacity-50 disabled:cursor-not-allowed"
            pButton
            label="Agregar manualmente"
            icon="pi pi-plus"
            iconPos="left"
            [disabled]="!f.valid || loading"
            (onClick)="actualizar()"
            [loading]="loading">
          </button>
          </div>
        </form>
        </div>
        </div>
      </div>
    </div>

    <!-- Segunda Fila: Paso 3 e Inventario Registrado -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
      <!-- Paso 3: Pallets Generados -->
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
        <div class="bg-gray-800 text-white px-4 py-2.5 border-b border-gray-700 flex justify-between items-center">
          <div>
            <h3 class="text-base font-semibold text-gray-100">Paso 3: Pallets Generados</h3>
            <p class="text-xs text-amber-300 mt-1">Pallets pendientes de procesar ({{ addInventario.length }} items)</p>
          </div>
          <div class="flex items-center gap-3">
            <div class="flex items-center gap-2 text-sm">
              <label class="text-gray-300">Sobredimensionado:</label>
              <p-inputSwitch 
                [(ngModel)]="sobredimensionado"
                (onChange)="changeSobredimensionado($event)">
              </p-inputSwitch>
            </div>
            <p-dropdown 
              *ngIf="sobredimensionado"
              [options]="nivel" 
              [(ngModel)]="modelDetail.sobredimensionadoId"
              placeholder="Nivel"
              [style]="{'width': '150px'}"
              styleClass="border-gray-300">
            </p-dropdown>
          </div>
        </div>
        <div class="p-6">
          <p-table 
            [value]="addInventario" 
            [columns]="colsPallets"
            [scrollable]="true"
            scrollHeight="250px"
            styleClass="p-datatable-sm mb-4">
            
            <ng-template pTemplate="colgroup" let-columns>
              <colgroup>
                <col *ngFor="let col of columns" [ngStyle]="{'width': col.width}">
              </colgroup>
            </ng-template>

            <ng-template pTemplate="header" let-columns>
              <tr class="bg-gray-100 border-b border-gray-200">
                <th *ngFor="let col of columns" [ngStyle]="{'width': col.width}" class="text-center px-4 py-2 text-sm font-semibold text-gray-700">
                  {{ col.header }}
                </th>
              </tr>
            </ng-template>

            <ng-template pTemplate="body" let-row>
              <tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors duration-150">
                <td class="text-center px-4 py-2">
                  <p-button
                    
                    icon="pi pi-times"
                    severity="danger"
                    [raised]="true"
                    [size]="small"
                    iconPos="left"
                    (click)="eliminarPallet(row.id)">
                  </p-button>
                </td>
                <td class="text-center px-4 py-2 text-gray-700 text-sm">{{ getCodigo(row) }}</td>
                <td class="text-center px-4 py-2 text-gray-700 text-sm">{{ row.descripcionLarga }}</td>
                <td class="text-center px-4 py-2 text-amber-700 text-sm font-medium">{{ row.untQty }}</td>
                <td class="text-center px-4 py-2">
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                    {{ row.estado }}
                  </span>
                </td>
              </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
              <tr>
                <td [attr.colspan]="colsPallets.length" class="text-center p-8">
                  <div class="flex flex-col items-center">
                    <i class="pi pi-inbox text-4xl mb-3 text-gray-300"></i>
                    <span class="text-gray-500 text-sm">No hay pallets generados</span>
                    <span class="text-gray-400 text-xs mt-1">Complete el formulario y agregue items a los pallets</span>
                  </div>
                </td>
              </tr>
            </ng-template>
          </p-table>

          <button
            class="w-full px-4 py-2 text-sm font-medium text-white bg-gray-700 hover:bg-gray-600 rounded-md shadow-sm transition-all duration-150 disabled:opacity-50 disabled:cursor-not-allowed"
            pButton
            label="Generar Pallet"
            icon="pi pi-check"
            iconPos="left"
            (click)="generarPallet()"
            [disabled]="addInventario.length === 0"
            [loading]="loading">
          </button>



          
        </div>
      </div>

      <!-- Inventario Registrado (Consulta) -->
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
        <div class="bg-gray-800 text-white px-4 py-2.5 border-b border-gray-700 flex justify-between items-center">
          <div>
            <h3 class="text-base font-semibold text-gray-100">Inventario Registrado</h3>
            <p class="text-xs text-amber-300 mt-1">Consulta de inventario ya registrado en el sistema</p>
          </div>
          <button
            class="px-3 py-1.5 text-xs font-medium text-white bg-gray-700 hover:bg-gray-600 rounded-md shadow-sm transition-all duration-150"
            pButton
            icon="pi pi-refresh"
            label="Actualizar"
            iconPos="left"
            (onClick)="mostrarInventario()">
          </button>
        </div>
        <div class="p-6">
          <p-table 
            [value]="inventario" 
            [columns]="colsInventario"
            [scrollable]="true"
            scrollHeight="250px"
            [paginator]="true"
            [rows]="10"
            styleClass="p-datatable-sm">
            
            <ng-template pTemplate="colgroup" let-columns>
              <colgroup>
                <col *ngFor="let col of columns" [ngStyle]="{'width': col.width}">
              </colgroup>
            </ng-template>

            <ng-template pTemplate="header" let-columns>
              <tr class="bg-gray-800 text-white">
                <th *ngFor="let col of columns" [ngStyle]="{'width': col.width}" class="text-center px-4 py-2 text-sm font-semibold text-white border-b border-gray-700">
                  {{ col.header }}
                </th>
              </tr>
            </ng-template>

            <ng-template pTemplate="body" let-row>
              <tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors duration-150">
                <td class="text-center px-4 py-2 text-gray-700 text-sm">{{ row.lodNum }}</td>
                <td class="text-center px-4 py-2 text-gray-700 text-sm">{{ row.descripcionLarga }}</td>
                <td class="text-center px-4 py-2 text-gray-700 text-sm">{{ row.ubicacion }}</td>
                <td class="text-center px-4 py-2 text-amber-700 text-sm font-medium">{{ row.untQty }}</td>
                <td class="text-center px-4 py-2">
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium" [ngClass]="row.seriado ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'">
                    {{ row.seriado ? 'Sí' : 'No' }}
                  </span>
                </td>
                <td class="text-center px-4 py-2 text-amber-700 text-sm font-medium">{{ row.scanQty || 0 }}</td>
              </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
              <tr>
                <td [attr.colspan]="colsInventario.length" class="text-center p-8">
                  <div class="flex flex-col items-center">
                    <i class="pi pi-inbox text-4xl mb-3 text-gray-300"></i>
                    <span class="text-gray-500 text-sm">No hay inventario registrado</span>
                    <span class="text-gray-400 text-xs mt-1">Haga clic en "Actualizar" para cargar el inventario</span>
                  </div>
                </td>
              </tr>
            </ng-template>
          </p-table>
        </div>
      </div>
    </div>
  </div>
</div>

<p-confirmDialog />
<p-toast />
