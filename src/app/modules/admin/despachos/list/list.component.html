<div class="flex flex-col flex-auto min-w-0 bg-gray-50">
  <!-- Header -->
  <div class="flex flex-col sm:flex-row flex-0 sm:items-center sm:justify-between p-6 sm:py-4 sm:px-10 border-b border-gray-200 bg-white shadow-sm">
    <div class="flex-1 min-w-0">
      <div class="flex flex-wrap items-center font-medium text-sm text-gray-600">
        <div>
          <a class="whitespace-nowrap text-gray-700 hover:text-gray-900">TWH</a>
        </div>
        <div class="flex items-center ml-1 whitespace-nowrap">
          <mat-icon class="fuse-horizontal-navigation-item-icon text-gray-400" [svgIcon]="'heroicons_solid:chevron-right'"></mat-icon>
          <a class="ml-1 text-gray-700 hover:text-gray-900">Picking</a>
        </div>
        <div class="flex items-center ml-1 whitespace-nowrap">
          <mat-icon class="fuse-horizontal-navigation-item-icon text-gray-400" [svgIcon]="'heroicons_solid:chevron-right'"></mat-icon>
          <a class="ml-1 text-gray-700 hover:text-gray-900">Lista Orden Salida</a>
        </div>
      </div>
      <div class="mt-1">
        <h2 class="text-3xl md:text-4xl font-semibold tracking-tight leading-7 sm:leading-10 truncate text-gray-900">
          Ordenes de salida 
        </h2>
      </div>
    </div>
  </div>

  <!-- Filtros -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 m-4 overflow-hidden">
    <!-- <div class="bg-gray-800 text-white px-4 py-2.5 border-b border-gray-700">
      <h3 class="text-base font-semibold text-gray-100">Filtros de Búsqueda</h3>
    </div> -->
    <div class="p-4">
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
        <!-- Almacén -->
        <div class="flex flex-col">
          <label for="almacen" class="text-xs font-medium text-gray-700 mb-1">Almacén:</label>
          <p-dropdown
            [options]="almacenes"
            [(ngModel)]="model.AlmacenId"
            [filter]="true"
            filterBy="label"
            [showClear]="true"
            [style]="{ width: '100%' }"
            appendTo="body"
            [resetFilterOnHide]="false"
            [hideTransitionOptions]="'0ms'"
            [showTransitionOptions]="'0ms'"
            placeholder="Seleccione un almacén"
            styleClass="text-sm border-gray-300">
            <ng-template let-item pTemplate="selectedItem">
              <span style="vertical-align: left">{{ item.label }}</span>
            </ng-template>
          </p-dropdown>
        </div>

        <!-- Propietario -->
        <div class="flex flex-col">
          <label for="propietario" class="text-xs font-medium text-gray-700 mb-1">Propietario:</label>
          <p-dropdown
            name="clientes"
            [options]="clientes"
            [(ngModel)]="model.PropietarioId"
            [filter]="true"
            filterBy="label"
            [showClear]="true"
            [style]="{ width: '100%' }"
            appendTo="body"
            [resetFilterOnHide]="false"
            [hideTransitionOptions]="'0ms'"
            [showTransitionOptions]="'0ms'"
            placeholder="Seleccione un propietario"
            styleClass="text-sm border-gray-300">
            <ng-template let-item pTemplate="selectedItem">
              <span style="vertical-align: left">{{ item.label }}</span>
            </ng-template>
          </p-dropdown>
        </div>

        <!-- Estado -->
        <div class="flex flex-col">
          <label for="estado" class="text-xs font-medium text-gray-700 mb-1">Estado:</label>
          <p-dropdown
            name="estado"
            [options]="estadosOrdenSalida"
            [(ngModel)]="model.estadoIdfiltro"
            [filter]="true"
            filterBy="label"
            [showClear]="true"
            [style]="{ width: '100%' }"
            appendTo="body"
            [resetFilterOnHide]="false"
            [hideTransitionOptions]="'0ms'"
            [showTransitionOptions]="'0ms'"
            placeholder="Todos"
            styleClass="text-sm border-gray-300">
            <ng-template let-item pTemplate="selectedItem">
              <span style="vertical-align: left">{{ item?.label }}</span>
            </ng-template>
          </p-dropdown>
        </div>

        <!-- Fecha Inicio -->
        <div class="flex flex-col">
          <label for="dateInicio" class="text-xs font-medium text-gray-700 mb-1">Fec. Inicio</label>
          <p-calendar
            id="dateInicio"
            appendTo="body"
            [(ngModel)]="dateInicio"
            dateFormat="dd.mm.yy"
            styleClass="text-sm border-gray-300"
          />
        </div>

        <!-- Fecha Fin -->
        <div class="flex flex-col">
          <label for="dateFin" class="text-xs font-medium text-gray-700 mb-1">Fec. Fin</label>
          <p-calendar
            id="dateFin"
            appendTo="body"
            [(ngModel)]="dateFin"
            dateFormat="dd.mm.yy"
            styleClass="text-sm border-gray-300"
          />
        </div>

        <!-- Nro Guía -->
        <div class="flex flex-col">
          <label class="text-xs font-medium text-gray-700 mb-1">Nro Guía:</label>
          <input
            pInputText
            minlength="5"
            maxlength="50"
            class="w-full text-sm border-gray-300"
            autocomplete="off"
            [(ngModel)]="model.guiaremision"
            name="guiaremision"
            #guiaremision="ngModel"
            type="text"
            placeholder="Número de guía"
          />
        </div>
      </div>

      <!-- Botones de Acción -->
      <div class="flex flex-wrap gap-2 mt-4 pt-4 border-t border-gray-200">
        <button
          class="px-4 py-2 text-sm font-medium text-white bg-gray-700 hover:bg-gray-600 rounded-md shadow-sm transition-all duration-150"
          pButton
          icon="fa fa-search"
          label="Buscar"
          iconPos="left"
          (click)="buscar()">
        </button>
        <button
          class="px-4 py-2 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-md shadow-sm transition-all duration-150"
          pButton
          icon="fa fa-plus"
          label="Nueva Orden Palmas"
          iconPos="left"
          (click)="nuevaorden()">
        </button>
        <button
          class="px-4 py-2 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-md shadow-sm transition-all duration-150"
          pButton
          icon="fa fa-plus"
          label="Nuevo Masivo"
          iconPos="left"
          (click)="nuevaordenmasiva()">
        </button>
        <button
          class="px-4 py-2 text-sm font-medium text-white bg-amber-600 hover:bg-amber-700 rounded-md shadow-sm transition-all duration-150"
          pButton
          icon="pi pi-shopping-cart"
          label="Nueva Orden"
          iconPos="left"
          (click)="nuevaOrdenB2B()">
        </button>
      </div>
    </div>
  </div>

  <!-- Tabla de Órdenes -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 mx-4 mb-4 overflow-hidden">
    <div class="bg-gray-800 text-white px-4 py-2.5 border-b border-gray-700">
      <h3 class="text-base font-semibold text-gray-100">Listado de Órdenes de Salida</h3>
      <p class="text-xs text-amber-300 mt-1">Total de órdenes: {{ ordenes.length }}</p>
    </div>
    <div class="p-4">
      <p-table
        [style]="{ width: '100%' }"
        [scrollable]="true"
        scrollHeight="600px"
        [columns]="cols"
        [value]="ordenes"
        [(selection)]="selectedRow"
        #dt
        [paginator]="true"
        [rows]="40"
        selectionMode="multiple"
        [responsive]="true"
        [tableStyle]="{ 'table-layout': 'fixed', width: '100%' }"
        styleClass="p-datatable-sm"
      >
        <!-- Encabezados -->
        <ng-template pTemplate="colgroup" let-columns>
          <colgroup>
            <col
              *ngFor="let col of columns"
              [ngStyle]="{ width: col.width }"
            />
          </colgroup>
        </ng-template>

        <ng-template pTemplate="header" let-columns>
          <tr class="bg-gray-800 text-white">
            <th
              *ngFor="let col of columns"
              [ngStyle]="{ width: col.width }"
              pResizableColumn
              [pSortableColumn]="col.field"
              class="text-center px-4 py-2 text-sm font-semibold text-white border-b border-gray-700"
            >
              {{ col.header }}
              <p-sortIcon [field]="col.field" ariaLabel="Activate to sort" ariaLabelDesc="Activate to sort in descending order" ariaLabelAsc="Activate to sort in ascending order"></p-sortIcon>
            </th>
          </tr>
        </ng-template>

        <!-- Cuerpo -->
        <ng-template pTemplate="body" let-rowData let-columns="columns">
          <tr [pSelectableRow]="rowData" class="border-b border-gray-100 hover:bg-gray-50 transition-colors duration-150">
            <!-- Acciones -->
            <td class="text-center px-4 py-2">
              <div class="flex flex-wrap justify-center gap-1">
                <p-button
                  severity="primary"
                  icon="fa fa-edit"
                  (click)="edit(rowData)"
                  [disabled]="!puedeEditar(rowData)"
                  [size]="small"
                  [raised]="true"
                ></p-button>

                <p-button
                  severity="danger"
                  icon="fa fa-trash"
                  (click)="delete(rowData.ordenSalidaId)"
                  [disabled]="rowData.nombreEstado != 'Creado'"
                  [size]="small"
                  [raised]="true"
                >
                </p-button>

                <p-button
                  severity="secondary"
                  icon="fa fa-search"
                  (click)="verDetalle(rowData)"
                  [size]="small"
                  [raised]="true"
                ></p-button>

                <p-button
                  severity="success"
                  icon="pi pi-plus"
                  (click)="agregarDetalle(rowData)"
                  [disabled]="rowData.nombreEstado != 'Creado'"
                  [size]="small"
                  [raised]="true"
                  pTooltip="Agregar detalle"
                  tooltipPosition="top"
                ></p-button>

                <p-button
                  severity="info"
                  icon="fa fa-calendar"
                  (click)="editarFechaSalida(rowData)"
                  [size]="small"
                  [raised]="true"
                  pTooltip="Editar fecha de salida"
                  tooltipPosition="top"
                ></p-button>
              </div>
            </td>

            <!-- Otras columnas -->
            <td class="text-center px-4 py-2 text-gray-700 text-sm">{{ rowData.numOrden }}</td>
            <td class="text-center px-4 py-2 text-gray-700 text-sm">{{ rowData.propietario }}</td>
            
            <!-- Estado con badge -->
            <td class="text-center px-4 py-2">
              <span
                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                [ngClass]="
                  rowData.nombreEstado == 'Almacenado'
                    ? 'bg-blue-100 text-blue-800'
                    : rowData.nombreEstado == 'Asignado'
                    ? 'bg-orange-100 text-orange-800'
                    : 'bg-gray-100 text-gray-800'
                "
              >
                {{ rowData.nombreEstado }}
              </span>
            </td>

            <td class="text-center px-4 py-2 text-gray-700 text-sm">{{ rowData.guiaRemision  }}  - {{ rowData.ordenCompraCliente }}</td>
            <td class="text-center px-4 py-2 text-gray-700 text-sm">{{ rowData.equipotransporte }} - {{ rowData.placa || '' }}</td>
            <td
              class="text-center px-4 py-2 text-sm"
              [ngClass]="
                rowData.tipoRegistro === 'CLIENTE'
                  ? 'text-blue-700 font-medium'
                  : 'text-gray-700'
              "
            >
              {{ rowData.usuarioregistro }}
            </td>
            <td class="text-center px-4 py-2 text-gray-700 text-sm">{{ rowData.fechaRequerida | date: 'dd/MM/yyyy' }}</td>
            <td class="text-center px-4 py-2 text-gray-700 text-sm">{{ rowData.fechaRegistro | date: 'dd/MM/yyyy' }}</td>
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
            <td [attr.colspan]="cols.length" class="text-center p-8">
              <div class="flex flex-col items-center">
                <i class="pi pi-inbox text-4xl mb-3 text-gray-300"></i>
                <span class="text-gray-500 text-sm">No hay órdenes disponibles</span>
                <span class="text-gray-400 text-xs mt-1">Use los filtros para buscar órdenes o cree una nueva</span>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>

  <!-- Dialog de Detalle de Orden de Salida -->
  <p-dialog
    header="Detalle de Orden de Salida"
    [modal]="true"
    [(visible)]="detalleOCModal"
    [style]="{ width: '70rem', maxWidth: '95vw' }"
    [contentStyle]="{ padding: '0.5rem' }"
    styleClass="p-fluid compact-dialog"
  >
    <ng-template pTemplate="content">
      <p-table
        class="custom-table compact-table"
        [columns]="cols2"
        [scrollable]="true"
        scrollHeight="350px"
        [style]="{ width: '100%' }"
        [value]="Items"
        #dt
        [paginator]="true"
        [rowsPerPageOptions]="[10, 20, 30, 50]"
        [globalFilterFields]="['producto', 'ProductoId', 'Lote']"
        [rows]="10"
        [responsive]="true"
        styleClass="p-datatable-sm p-datatable-compact"
      >
        <ng-template pTemplate="header" let-columns>
          <tr class="bg-gray-800 text-white">
            <th
              *ngFor="let col of columns"
              [ngStyle]="{ width: col.width, 'background-color': col.backgroundcolor }"
              pResizableColumn
              [pSortableColumn]="col.field"
              class="text-center px-2 py-1 text-xs font-semibold text-white border-b border-gray-700"
            >
              {{ col.header }}
            </th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-rowData let-columns="columns" let-editing="editing" let-rowIndex="rowIndex">
          <tr [pSelectableRow]="rowData" class="border-b border-gray-100 hover:bg-gray-50 transition-colors duration-150">
            <td class="text-center px-2 py-1 text-gray-700">{{ rowData.codigo}}</td>
            <td class="px-2 py-1 text-gray-700">{{ rowData.producto  }}</td>
            <td class="text-center px-2 py-1 text-gray-700 ">{{ rowData.lote  }}</td>
            <td class="text-center px-2 py-1 text-amber-700 font-medium">{{ rowData.cantidad || 0 }}</td>
            <td class="text-center px-2 py-1 text-gray-700 ">{{ rowData.estado  }}</td>
          </tr>
        </ng-template>
      </p-table>
    </ng-template>

    <ng-template pTemplate="footer">
      <button
        class="px-3 py-1.5 text-xs font-medium text-gray-700 bg-white border border-gray-300 hover:bg-gray-50 rounded-md shadow-sm transition-all duration-150"
        pButton
        label="Cerrar"
        icon="pi pi-times"
        iconPos="left"
        (click)="detalleOCModal = false">
      </button>
    </ng-template>
  </p-dialog>

  <!-- Dialog para editar fecha de salida -->
  <p-dialog
    header="Editar Fecha de Salida"
    [(visible)]="mostrarDialogFechaSalida"
    [modal]="true"
    [style]="{ width: '450px' }"
    styleClass="p-fluid"
  >
    <ng-template pTemplate="content">
      <div class="flex flex-col gap-4 py-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Orden de Salida: <strong>{{ ordenSalidaSeleccionada?.numOrden }}</strong>
          </label>
        </div>
        
        <div class="flex flex-col">
          <label for="fechaSalida" class="block text-sm font-medium text-gray-700 mb-2">
            Fecha de Salida <span class="text-red-500">*</span>
          </label>
          <p-calendar
            id="fechaSalida"
            [(ngModel)]="fechaSalidaEditada"
            [locale]="es"
            dateFormat="dd/mm/yy"
            [showIcon]="true"
            appendTo="body"
            styleClass="w-full"
            [styleClass]="'text-sm border-gray-300'"
          ></p-calendar>
        </div>
      </div>
    </ng-template>

    <ng-template pTemplate="footer">
      <div class="flex justify-end gap-2">
        <p-button
          label="Cancelar"
          icon="pi pi-times"
          severity="secondary"
          (onClick)="cancelarEditarFechaSalida()"
          [disabled]="loading"
        ></p-button>
        <p-button
          label="Guardar"
          icon="pi pi-check"
          (onClick)="guardarFechaSalida()"
          [loading]="loading"
        ></p-button>
      </div>
    </ng-template>
  </p-dialog>

  <p-confirmDialog />
  <p-toast />
</div>
