<div class="flex flex-col flex-auto min-w-0 bg-gray-50">
  <!-- Header -->
  <div class="flex flex-col sm:flex-row flex-0 sm:items-center sm:justify-between p-6 sm:py-4 sm:px-10 border-b border-gray-200 bg-white shadow-sm">
    <div class="flex-1 min-w-0">
      <div class="flex flex-wrap items-center font-medium text-sm text-gray-600">
        <div>
          <a class="whitespace-nowrap text-gray-700 hover:text-gray-900">TWH</a>
        </div>
        <div class="flex items-center ml-1 whitespace-nowrap">
          <mat-icon class="fuse-horizontal-navigation-item-icon text-gray-400" [svgIcon]="'heroicons_solid:chevron-right'"></mat-icon>
          <a class="ml-1 text-gray-700 hover:text-gray-900">B2B</a>
        </div>
        <div class="flex items-center ml-1 whitespace-nowrap">
          <mat-icon class="fuse-horizontal-navigation-item-icon text-gray-400" [svgIcon]="'heroicons_solid:chevron-right'"></mat-icon>
          <a class="ml-1 text-gray-700 hover:text-gray-900">{{ esModoEdicion ? 'Editar Orden de Salida' : 'Nueva Orden de Salida' }}</a>
        </div>
      </div>
      <div class="mt-1">
        <h2 class="text-3xl md:text-4xl font-semibold tracking-tight leading-7 sm:leading-10 truncate text-gray-900">
          {{ esModoEdicion ? 'Editar Orden de Salida' : 'Nueva Orden de Salida' }}
        </h2>
        <p class="mt-1 text-sm text-gray-500">
          {{ esModoEdicion ? 'Modifique los datos de la orden de salida' : 'Datos de cabecera de la orden de salida' }}
        </p>
      </div>
    </div>
    <div class="flex items-center gap-2 mt-4 sm:mt-0">
      <button
        class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 hover:bg-gray-50 rounded-md shadow-sm transition-all duration-150"
        pButton
        type="button"
        label="Cancelar"
        icon="pi pi-times"
        iconPos="left"
        (click)="cancelar()">
      </button>
      <button
        class="px-4 py-2 text-sm font-medium text-white bg-amber-600 hover:bg-amber-700 rounded-md shadow-sm transition-all duration-150"
        pButton
        type="submit"
        form="formSalida"
        [label]="esModoEdicion ? 'Actualizar' : 'Guardar'"
        [icon]="esModoEdicion ? 'pi pi-check' : 'pi pi-save'"
        iconPos="left">
      </button>
    </div>
  </div>

  <!-- Formulario -->
  <form
    [formGroup]="form"
    (ngSubmit)="registrar()"
    id="formSalida"
    class="p-6 space-y-6"
  >
    <!-- Panel: Datos de cabecera de la orden de salida -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
      <div class="bg-gray-800 text-white px-4 py-2.5 border-b border-gray-700">
        <h3 class="text-base font-semibold text-gray-100">Datos de cabecera de la orden de salida</h3>
      </div>
      <div class="p-4">
        <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
          <!-- Columna Izquierda -->
          <div class="space-y-4">
            <!-- Almac茅n -->
            <div class="flex flex-col">
              <label class="text-xs font-medium text-gray-700 mb-1">Almac茅n: <span class="text-red-500">*</span></label>
              <p-dropdown
                formControlName="almacenId"
                [options]="almacenes"
                [filter]="true"
                filterBy="label"
                [showClear]="true"
                [style]="{ 'width': '100%' }"
                appendTo="body"
                [resetFilterOnHide]="false"
                [hideTransitionOptions]="'0ms'"
                [showTransitionOptions]="'0ms'"
                placeholder="seleccione un almacen"
                [ngClass]="{
                  'p-invalid': (form.get('almacenId')?.touched || form.get('almacenId')?.dirty) && form.get('almacenId')?.invalid
                }"
                styleClass="text-sm">
                <ng-template let-item pTemplate="selectedItem">
                  <span style="vertical-align: left">{{ item.label }}</span>
                </ng-template>
              </p-dropdown>
              <small *ngIf="(form.get('almacenId')?.touched || form.get('almacenId')?.dirty) && form.get('almacenId')?.invalid" class="p-error text-xs mt-1">
                El almac茅n es obligatorio.
              </small>
            </div>

            <!-- Propietario -->
            <div class="flex flex-col">
              <label class="text-xs font-medium text-gray-700 mb-1">Propietario: <span class="text-red-500">*</span></label>
              <p-dropdown
                formControlName="propietarioId"
                [options]="propietarios"
                [filter]="true"
                filterBy="label"
                [showClear]="true"
                [style]="{ 'width': '100%' }"
                appendTo="body"
                [resetFilterOnHide]="false"
                [hideTransitionOptions]="'0ms'"
                [showTransitionOptions]="'0ms'"
                placeholder="seleccione un propietario"
                [ngClass]="{
                  'p-invalid': (form.get('propietarioId')?.touched || form.get('propietarioId')?.dirty) && form.get('propietarioId')?.invalid
                }"
                styleClass="text-sm">
                <ng-template let-item pTemplate="selectedItem">
                  <span style="vertical-align: left">{{ item.label }}</span>
                </ng-template>
              </p-dropdown>
              <small *ngIf="(form.get('propietarioId')?.touched || form.get('propietarioId')?.dirty) && form.get('propietarioId')?.invalid" class="p-error text-xs mt-1">
                El propietario es obligatorio.
              </small>
            </div>

            <!-- Fecha Requerida -->
            <div class="flex flex-col">
              <label class="text-xs font-medium text-gray-700 mb-1">Fecha de requerida: <span class="text-red-500">*</span></label>
              <p-calendar
                formControlName="fechaRequerida"
                [showIcon]="true"
                appendTo="body"
                dateFormat="yy-mm-dd"
                [style]="{ width: '100%' }"
                [ngClass]="{
                  'p-invalid': (form.get('fechaRequerida')?.touched || form.get('fechaRequerida')?.dirty) && form.get('fechaRequerida')?.invalid
                }"
                styleClass="text-sm"
              ></p-calendar>
              <small *ngIf="(form.get('fechaRequerida')?.touched || form.get('fechaRequerida')?.dirty) && form.get('fechaRequerida')?.invalid" class="p-error text-xs mt-1">
                La fecha requerida es obligatoria.
              </small>
            </div>

            <!-- Hora Requerida -->
            <div class="flex flex-col">
              <label class="text-xs font-medium text-gray-700 mb-1">Hora requerida: <span class="text-red-500">*</span></label>
              <p-calendar
                formControlName="horaRequerida"
                [timeOnly]="true"
                appendTo="body"
                [style]="{ width: '100%' }"
                [ngClass]="{
                  'p-invalid': (form.get('horaRequerida')?.touched || form.get('horaRequerida')?.dirty) && form.get('horaRequerida')?.invalid
                }"
                styleClass="text-sm"
              ></p-calendar>
              <small *ngIf="(form.get('horaRequerida')?.touched || form.get('horaRequerida')?.dirty) && form.get('horaRequerida')?.invalid" class="p-error text-xs mt-1">
                La hora requerida es obligatoria.
              </small>
            </div>

            <!-- Cliente -->
            <div class="flex flex-col">
              <label class="text-xs font-medium text-gray-700 mb-1">Cliente: <span class="text-red-500">*</span></label>
              <p-dropdown
                formControlName="clienteId"
                [options]="clientes"
                [filter]="true"
                filterBy="label"
                [showClear]="true"
                [style]="{ 'width': '100%' }"
                appendTo="body"
                [resetFilterOnHide]="false"
                [hideTransitionOptions]="'0ms'"
                [showTransitionOptions]="'0ms'"
                placeholder="seleccione un cliente"
                [disabled]="!form.get('propietarioId')?.value"
                [ngClass]="{
                  'p-invalid': (form.get('clienteId')?.touched || form.get('clienteId')?.dirty) && form.get('clienteId')?.invalid
                }"
                styleClass="text-sm">
                <ng-template let-item pTemplate="selectedItem">
                  <span style="vertical-align: left">{{ item.label }}</span>
                </ng-template>
              </p-dropdown>
              <small *ngIf="(form.get('clienteId')?.touched || form.get('clienteId')?.dirty) && form.get('clienteId')?.invalid" class="p-error text-xs mt-1">
                El cliente es obligatorio.
              </small>
            </div>

            <!-- Direcci贸n Entrega -->
            <div class="flex flex-col">
              <label class="text-xs font-medium text-gray-700 mb-1">Direcci贸n Entrega: <span class="text-red-500">*</span></label>
              <p-dropdown
                formControlName="direccionId"
                [options]="direcciones"
                [filter]="true"
                filterBy="label"
                [showClear]="true"
                [style]="{ 'width': '100%' }"
                appendTo="body"
                [resetFilterOnHide]="false"
                [hideTransitionOptions]="'0ms'"
                [showTransitionOptions]="'0ms'"
                placeholder="seleccione una direcci贸n de entrega"
                [disabled]="!form.get('clienteId')?.value"
                [ngClass]="{
                  'p-invalid': (form.get('direccionId')?.touched || form.get('direccionId')?.dirty) && form.get('direccionId')?.invalid
                }"
                styleClass="text-sm">
                <ng-template let-item pTemplate="selectedItem">
                  <span style="vertical-align: left">{{ item.label }}</span>
                </ng-template>
              </p-dropdown>
              <small *ngIf="(form.get('direccionId')?.touched || form.get('direccionId')?.dirty) && form.get('direccionId')?.invalid" class="p-error text-xs mt-1">
                La direcci贸n de entrega es obligatoria.
              </small>
            </div>
          </div>

          <!-- Columna Derecha -->
          <div class="space-y-4">
            <!-- OC del Cliente -->
            <div class="flex flex-col">
              <label class="text-xs font-medium text-gray-700 mb-1">OC del Cliente: <span class="text-red-500">*</span></label>
              <input
                pInputText
                formControlName="ordenCompraCliente"
                placeholder="Ej: OC-102233"
                autocomplete="off"
                [ngClass]="{
                  'p-invalid': (form.get('ordenCompraCliente')?.touched || form.get('ordenCompraCliente')?.dirty) && form.get('ordenCompraCliente')?.invalid
                }"
                class="w-full text-sm"
              />
              <small *ngIf="(form.get('ordenCompraCliente')?.touched || form.get('ordenCompraCliente')?.dirty) && form.get('ordenCompraCliente')?.invalid" class="p-error text-xs mt-1">
                La orden de compra del cliente es obligatoria.
              </small>
            </div>

            <!-- Gu铆a de Remisi贸n -->
            <div class="flex flex-col">
              <label class="text-xs font-medium text-gray-700 mb-1">Gu铆a de Remisi贸n:</label>
              <input
                pInputText
                formControlName="guiaRemision"
                placeholder="Ingrese la gu铆a de remisi贸n"
                autocomplete="off"
                class="w-full text-sm border-gray-300"
              />
            </div>

            <!-- Orden Entrega -->
            <div class="flex flex-col">
              <label class="text-xs font-medium text-gray-700 mb-1">Orden Entrega:</label>
              <input
                pInputText
                formControlName="ordenEntrega"
                placeholder="Ingrese la orden de entrega"
                autocomplete="off"
                class="w-full text-sm border-gray-300"
              />
            </div>

            <!-- Orden Infor -->
            <div class="flex flex-col">
              <label class="text-xs font-medium text-gray-700 mb-1">Orden Infor:</label>
              <input
                pInputText
                formControlName="ordenInfor"
                placeholder="Ingrese la orden Infor"
                autocomplete="off"
                class="w-full text-sm border-gray-300"
              />
            </div>

            <!-- Tipo Descarga -->
            <div class="flex flex-col">
              <label class="text-xs font-medium text-gray-700 mb-1">Tipo Descarga:</label>
              <p-dropdown
                formControlName="tipoDescargaId"
                [options]="tiposDescarga"
                [filter]="true"
                filterBy="label"
                [showClear]="true"
                [style]="{ 'width': '100%' }"
                appendTo="body"
                [resetFilterOnHide]="false"
                [hideTransitionOptions]="'0ms'"
                [showTransitionOptions]="'0ms'"
                placeholder="seleccione un tipo de descarga"
                styleClass="text-sm border-gray-300">
                <ng-template let-item pTemplate="selectedItem">
                  <span style="vertical-align: left">{{ item.label }}</span>
                </ng-template>
              </p-dropdown>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Panel 3: Detalle del Pedido -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
      <div class="bg-gray-800 text-white px-4 py-2.5 border-b border-gray-700">
        <h3 class="text-base font-semibold text-gray-100">Detalle del Pedido</h3>
        <p class="text-xs text-amber-300 mt-1">Agregue los productos que desea incluir en la orden</p>
      </div>
      <div class="p-4">
        <div class="grid grid-cols-1 gap-6 lg:grid-cols-3">
          <!-- Columna Izquierda: Formulario para agregar 铆tem -->
          <div>
            <div class="bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden">
              <div class="bg-gray-100 px-4 py-2 border-b border-gray-200">
                <h4 class="text-sm font-semibold text-gray-800">Agregar nuevo 铆tem</h4>
              </div>
              <div class="p-4">
                <!-- Producto -->
                <label class="block text-xs font-medium text-gray-700 mb-1">Producto</label>
                <p-autoComplete
                  [(ngModel)]="model.productoSeleccionado"
                  [suggestions]="productosFiltrados"
                  [ngModelOptions]="{ standalone: true }"
                  (completeMethod)="buscarProductos($event)"
                  [minLength]="2"
                  appendTo="body"
                  [delay]="300"
                  [field]="'nombreCompleto'"
                  [dropdown]="true"
                  [forceSelection]="true"
                  [style]="{ width: '100%' }"
                  styleClass="text-sm border-gray-300"
                >
                  <ng-template let-item pTemplate="item">
                    <div class="flex items-center justify-between">
                      <span>{{ item.nombreCompleto }}</span>
                      <small class="text-gray-500">({{ item.unidad }})</small>
                    </div>
                  </ng-template>

                  <ng-template let-item pTemplate="selectedItem">
                    <div>{{ item.nombreCompleto }}</div>
                  </ng-template>
                </p-autoComplete>

                <!-- Enlace para ver stock -->
                  <div class="mt-2 flex justify-between items-center gap-2">
                  <a
                    class="cursor-pointer text-xs text-blue-600 hover:underline flex items-center gap-1"
                    (click)="verStock()"
                    *ngIf="model.productoSeleccionado"
                  >
                    <i class="pi pi-chart-bar"></i>
                    <span>Ver stock</span>
                  </a>

                  <a
                    class="cursor-pointer text-xs text-green-600 hover:underline font-semibold flex items-center gap-1"
                    (click)="verLotes()"
                    *ngIf="model.productoSeleccionado"
                  >
                    <i class="pi pi-box"></i>
                    <span>Ver lotes disponibles</span>
                  </a>
                </div>

                <!-- Cantidad -->
                <div class="mt-3">
                  <label class="block text-xs font-medium text-gray-700 mb-1">Cantidad</label>
                  <input
                    pInputText
                    type="number"
                    [ngModelOptions]="{ standalone: true }"
                    min="1"
                    [(ngModel)]="model.cantidad"
                    class="w-full text-sm border-gray-300"
                  />
                </div>

                <!-- Lote -->
                <div class="mt-3">
                  <label class="block text-xs font-medium text-gray-700 mb-1">Lote </label>
                  <input
                    pInputText
                    type="text"
                    [ngModelOptions]="{ standalone: true }"
                    [(ngModel)]="model.lote"
                    class="w-full text-sm border-gray-300"
                  />
                </div>

                <!-- Referencia -->
                <div class="mt-3">
                  <label class="block text-xs font-medium text-gray-700 mb-1">Referencia (DUA / OC)</label>
                  <input
                    pInputText
                    type="text"
                    [ngModelOptions]="{ standalone: true }"
                    [(ngModel)]="model.referencia"
                    class="w-full text-sm border-gray-300"
                  />
                </div>

                <!-- Estado -->
                <div class="mt-3">
                  <label class="block text-xs font-medium text-gray-700 mb-1">Estado</label>
                  <p-dropdown
                    [options]="estados"
                    [(ngModel)]="model.estadoId"
                    [ngModelOptions]="{ standalone: true }"
                    [filter]="true"
                    filterBy="label"
                    [showClear]="false"
                    [style]="{ 'width': '100%' }"
                    appendTo="body"
                    [resetFilterOnHide]="false"
                    [hideTransitionOptions]="'0ms'"
                    [showTransitionOptions]="'0ms'"
                    placeholder="Seleccione un estado"
                    styleClass="text-sm border-gray-300">
                    <ng-template let-item pTemplate="selectedItem">
                      <span style="vertical-align: left">{{ item.label }}</span>
                    </ng-template>
                  </p-dropdown>
                </div>

                <!-- Bot贸n -->
                <div class="mt-4">
                  <button
                    class="w-full px-3 py-1.5 text-xs font-medium text-white bg-amber-600 hover:bg-amber-700 rounded-md shadow-sm transition-all duration-150"
                    pButton
                    label="Agregar 铆tem"
                    type="button"
                    icon="pi pi-plus"
                    iconPos="left"
                    (click)="agregarItem()">
                  </button>
                </div>
              </div>
            </div>

            <!-- Di谩logo de stock -->
            <p-dialog
              header="Stock Disponible"
              [(visible)]="dialogStockVisible"
              [modal]="true"
              [closable]="true"
              [style]="{ width: '400px' }"
              styleClass="p-fluid"
            >
              <div *ngIf="stockInfo; else cargandoStock" class="space-y-2">
                <p class="text-sm">
                  <strong class="text-gray-700">Producto:</strong>
                  <span class="text-gray-900">{{ stockInfo.codigo }}</span>
                </p>
                <p class="text-sm">
                  <strong class="text-gray-700">Descripci贸n:</strong>
                  <span class="text-gray-900">{{ stockInfo.descripcionLarga }}</span>
                </p>
                <p class="text-sm">
                  <strong class="text-gray-700">Stock disponible:</strong>
                  <span class="text-amber-700 font-medium">{{ stockInfo.stockDisponibleTotal }} {{ stockInfo.unidadAlmacenamiento }}</span>
                </p>
                <p class="text-sm">
                  <strong class="text-gray-700">Estado:</strong>
                  <span class="text-gray-900">{{ stockInfo.estado }}</span>
                </p>
              </div>

              <ng-template #cargandoStock>
                <div class="text-center text-gray-500 py-4">
                  <i class="pi pi-spin pi-spinner mr-2"></i>
                  Consultando stock...
                </div>
              </ng-template>
            </p-dialog>

            <!-- DILOGO DE LOTES DISPONIBLES -->
            <p-dialog
              header="Lotes Disponibles en Inventario"
              [(visible)]="dialogLotesVisible"
              [modal]="true"
              [closable]="true"
              [style]="{ width: '900px', maxWidth: '95vw' }"
              [contentStyle]="{ overflow: 'visible' }"
            >
              <ng-template pTemplate="header">
                <div class="flex items-center gap-2">
                  <i class="pi pi-box text-amber-600 text-xl"></i>
                  <div>
                    <div class="font-semibold text-lg">Lotes Disponibles</div>
                    <div class="text-xs text-gray-600" *ngIf="model.productoSeleccionado">
                      {{ model.productoSeleccionado.codigo }} - {{ model.productoSeleccionado.nombreCompleto }}
                    </div>
                  </div>
                </div>
              </ng-template>

              <!-- Contenido del modal -->
              <div *ngIf="lotesInfo && lotesInfo.length > 0; else sinLotes">
                <div class="mb-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                  <i class="pi pi-info-circle text-blue-600 mr-2"></i>
                  <span class="text-sm text-blue-900">
                    Haga clic en "Usar" para seleccionar un lote y agregarlo autom谩ticamente
                  </span>
                </div>

                <p-table
                  [value]="lotesInfo"
                  [scrollable]="true"
                  scrollHeight="400px"
                  styleClass="p-datatable-sm p-datatable-striped"
                  [paginator]="lotesInfo.length > 10"
                  [rows]="10"
                  [rowsPerPageOptions]="[10, 20, 50]"
                >
                  <ng-template pTemplate="header">
                    <tr class="bg-gray-800 text-white">
                      <th class="text-sm font-semibold text-white px-4 py-3" pSortableColumn="numeroLote">
                        N煤mero de Lote
                        <p-sortIcon field="numeroLote"></p-sortIcon>
                      </th>
                      <th class="text-sm font-semibold text-white px-4 py-3 text-right" pSortableColumn="cantidadDisponible">
                        Cantidad
                        <p-sortIcon field="cantidadDisponible"></p-sortIcon>
                      </th>
                      <th class="text-sm font-semibold text-white px-4 py-3">Unidad</th>
                      <th class="text-sm font-semibold text-white px-4 py-3" pSortableColumn="fechaVencimiento">
                        Fecha Venc.
                        <p-sortIcon field="fechaVencimiento"></p-sortIcon>
                      </th>
                      <th class="text-sm font-semibold text-white px-4 py-3">Ubicaci贸n</th>
                      <th class="text-sm font-semibold text-white px-4 py-3">Estado</th>
                      <th class="text-sm font-semibold text-white px-4 py-3 text-center">Acci贸n</th>
                    </tr>
                  </ng-template>

                  <ng-template pTemplate="body" let-lote>
                    <tr class="hover:bg-gray-50 transition-colors border-b border-gray-100">
                      <td class="text-sm px-4 py-3">
                        <span class="font-medium text-gray-900">{{ lote.numeroLote }}</span>
                      </td>
                      <td class="text-sm text-right px-4 py-3">
                        <span class="font-semibold px-2 py-1 rounded" [ngClass]="{
                          'bg-green-100 text-green-800': lote.cantidadDisponible > 50,
                          'bg-amber-100 text-amber-800': lote.cantidadDisponible > 0 && lote.cantidadDisponible <= 50,
                          'bg-red-100 text-red-800': lote.cantidadDisponible === 0
                        }">
                          {{ lote.cantidadDisponible }}
                        </span>
                      </td>
                      <td class="text-sm text-gray-700 px-4 py-3">{{ lote.unidad || 'UND' }}</td>
                      <td class="text-sm text-gray-700 px-4 py-3">
                        <span *ngIf="lote.fechaVencimiento" class="flex items-center gap-1">
                          <i class="pi pi-calendar text-gray-400 text-xs"></i>
                          {{ lote.fechaVencimiento | date:'dd/MM/yyyy' }}
                        </span>
                        <span *ngIf="!lote.fechaVencimiento" class="text-gray-400">Sin fecha</span>
                      </td>
                      <td class="text-sm text-gray-700 px-4 py-3">
                        <span *ngIf="lote.ubicacion" class="flex items-center gap-1">
                          <i class="pi pi-map-marker text-gray-400 text-xs"></i>
                          {{ lote.ubicacion }}
                        </span>
                        <span *ngIf="!lote.ubicacion" class="text-gray-400">-</span>
                      </td>
                      <td class="text-sm px-4 py-3">
                        <span class="px-2 py-1 rounded-full text-xs font-medium" [ngClass]="{
                          'bg-green-100 text-green-800': lote.estado === 'Activo' || lote.estado === 'Disponible',
                          'bg-amber-100 text-amber-800': lote.estado === 'Por Vencer',
                          'bg-red-100 text-red-800': lote.estado === 'Vencido' || lote.estado === 'Bloqueado',
                          'bg-gray-100 text-gray-800': !lote.estado
                        }">
                          {{ lote.estado || 'Disponible' }}
                        </span>
                      </td>
                      <td class="text-center px-4 py-3">
                        <button
                          pButton
                          type="button"
                          icon="pi pi-check"
                          class="p-button-sm p-button-success"
                          label="Usar"
                          (click)="seleccionarLote(lote)"
                          [disabled]="lote.cantidadDisponible === 0 || lote.estado === 'Vencido' || lote.estado === 'Bloqueado'"
                          [pTooltip]="lote.cantidadDisponible === 0 ? 'Sin stock disponible' : 'Seleccionar este lote'"
                          tooltipPosition="left"
                        ></button>
                      </td>
                    </tr>
                  </ng-template>

                  <ng-template pTemplate="emptymessage">
                    <tr>
                      <td colspan="7" class="text-center py-8">
                        <i class="pi pi-inbox text-4xl text-gray-300 mb-2"></i>
                        <p class="text-gray-500">No hay lotes disponibles</p>
                      </td>
                    </tr>
                  </ng-template>
                </p-table>

                <!-- Informaci贸n adicional -->
                <div class="mt-4 p-4 bg-gray-50 border border-gray-200 rounded-lg">
                  <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div class="flex items-center gap-3 p-3 bg-white rounded border border-gray-200">
                      <i class="pi pi-box text-blue-600 text-2xl"></i>
                      <div>
                        <div class="text-xs text-gray-600">Total de Lotes</div>
                        <div class="text-xl font-bold text-gray-900">{{ lotesInfo.length }}</div>
                      </div>
                    </div>

                    <div class="flex items-center gap-3 p-3 bg-white rounded border border-gray-200">
                      <i class="pi pi-check-circle text-green-600 text-2xl"></i>
                      <div>
                        <div class="text-xs text-gray-600">Stock Total</div>
                        <div class="text-xl font-bold text-green-700">
                          {{ calcularStockTotal() }}
                        </div>
                      </div>
                    </div>

                    <div class="flex items-center gap-3 p-3 bg-white rounded border border-gray-200">
                      <i class="pi pi-calendar text-amber-600 text-2xl"></i>
                      <div>
                        <div class="text-xs text-gray-600">Pr贸ximo Vencimiento</div>
                        <div class="text-sm font-bold text-amber-700">
                          {{ obtenerProximoVencimiento() }}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Tips -->
                <div class="mt-4 p-3 bg-amber-50 border-l-4 border-amber-500 rounded">
                  <div class="flex items-start gap-2">
                    <i class="pi pi-lightbulb text-amber-600 text-lg mt-0.5"></i>
                    <div class="text-sm text-amber-900">
                      <p class="font-semibold mb-2"> Recomendaciones:</p>
                      <ul class="list-disc list-inside space-y-1 text-amber-800">
                        <li>Priorice lotes con fecha de vencimiento m谩s pr贸xima (FEFO)</li>
                        <li>Los lotes marcados en 谩mbar tienen stock limitado</li>
                        <li>La cantidad se ajustar谩 autom谩ticamente si excede el disponible</li>
                        <li>No puede seleccionar lotes vencidos o bloqueados</li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Template: Sin lotes -->
              <ng-template #sinLotes>
                <div class="text-center py-12">
                  <i class="pi pi-inbox text-6xl text-gray-300 mb-4"></i>
                  <p class="text-gray-600 text-lg font-medium">No hay lotes disponibles</p>
                  <p class="text-gray-500 text-sm mt-2">
                    Este producto no tiene lotes registrados en el inventario
                  </p>
                  <button
                    pButton
                    type="button"
                    label="Cerrar"
                    icon="pi pi-times"
                    class="p-button-secondary mt-4"
                    (click)="dialogLotesVisible = false"
                  ></button>
                </div>
              </ng-template>

              <!-- Footer -->
              <ng-template pTemplate="footer">
                <div class="flex justify-between items-center">
                  <div class="text-xs text-gray-500">
                    <i class="pi pi-info-circle mr-1"></i>
                    Seleccione un lote para continuar
                  </div>
                  <button
                    pButton
                    type="button"
                    label="Cerrar"
                    icon="pi pi-times"
                    class="p-button-secondary"
                    (click)="dialogLotesVisible = false"
                  ></button>
                </div>
              </ng-template>
            </p-dialog>
          </div>

          <!-- Columna Derecha: Tabla de detalle -->
          <div class="lg:col-span-2">
            <p-table
              [value]="detalle"
              dataKey="codigo"
              class="w-full"
              styleClass="p-datatable-sm"
              [scrollable]="true"
              scrollHeight="400px"
            >
              <ng-template pTemplate="header">
                <tr class="bg-gray-800 text-white">
                  <th class="text-center px-4 py-2 text-sm font-semibold text-white border-b border-gray-700" style="width: 100px">C贸digo</th>
                  <th class="text-center px-4 py-2 text-sm font-semibold text-white border-b border-gray-700">Descripci贸n</th>
                  <th class="text-center px-4 py-2 text-sm font-semibold text-white border-b border-gray-700" style="width: 100px">Lote</th>
                  <th class="text-center px-4 py-2 text-sm font-semibold text-white border-b border-gray-700" style="width: 120px">Referencia</th>
                  <th class="text-center px-4 py-2 text-sm font-semibold text-white border-b border-gray-700" style="width: 80px">Cantidad</th>
                  <th class="text-center px-4 py-2 text-sm font-semibold text-white border-b border-gray-700" style="width: 80px">Unidad</th>
                  <th class="text-center px-4 py-2 text-sm font-semibold text-white border-b border-gray-700" style="width: 120px">Estado</th>
                  <th class="text-center px-4 py-2 text-sm font-semibold text-white border-b border-gray-700" style="width: 80px">Acciones</th>
                </tr>
              </ng-template>

              <ng-template pTemplate="body" let-row let-i="rowIndex">
                <tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors duration-150">
                  <td class="text-center px-4 py-2 text-gray-700 text-sm">{{ row.codigo }}</td>
                  <td class="px-4 py-2 text-gray-700 text-sm">{{ row.descripcion }}</td>
                  <td class="text-center px-4 py-2 text-gray-700 text-sm">
                    <span *ngIf="row.lote" class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-medium">{{ row.lote }}</span>
                    <span *ngIf="!row.lote" class="text-gray-400 text-xs">-</span>
                  </td>
                  <td class="text-center px-4 py-2 text-gray-700 text-sm">
                    <span *ngIf="row.referencia">{{ row.referencia }}</span>
                    <span *ngIf="!row.referencia" class="text-gray-400 text-xs">-</span>
                  </td>
                  <td class="text-center px-4 py-2 text-amber-700 text-sm font-medium">{{ row.cantidad }}</td>
                  <td class="text-center px-4 py-2 text-gray-700 text-sm">{{ row.unidadMedida }}</td>
                  <td class="text-center px-4 py-2 text-gray-700 text-sm">
                    <span *ngIf="row.estadoId" class="px-2 py-1 bg-gray-100 text-gray-800 rounded text-xs font-medium">
                      {{ getEstadoLabel(row.estadoId) }}
                    </span>
                    <span *ngIf="!row.estadoId" class="text-gray-400 text-xs">-</span>
                  </td>
                  <td class="text-center px-4 py-2">
                    <button
                      pButton
                      icon="pi pi-trash"
                      (click)="eliminarFila(i)"
                      class="p-button-sm p-button-danger"
                      type="button"
                      [size]="small"
                      [raised]="true"
                    ></button>
                  </td>
                </tr>
              </ng-template>

              <ng-template pTemplate="emptymessage">
                <tr>
                  <td [attr.colspan]="7" class="text-center p-8">
                    <div class="flex flex-col items-center">
                      <i class="pi pi-inbox text-4xl mb-3 text-gray-300"></i>
                      <span class="text-gray-500 text-sm">No hay productos agregados a煤n</span>
                      <span class="text-gray-400 text-xs mt-1">Use el formulario a la izquierda para agregar productos</span>
                    </div>
                  </td>
                </tr>
              </ng-template>
            </p-table>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>

<p-confirmDialog />
<p-toast />

