<div class="flex flex-col flex-auto min-w-0 bg-gray-50">
  <!-- Header -->
  <div class="flex flex-col sm:flex-row flex-0 sm:items-center sm:justify-between p-6 sm:py-4 sm:px-10 border-b border-gray-200 bg-white shadow-sm">
    <div class="flex-1 min-w-0">
      <div class="flex flex-wrap items-center font-medium text-sm text-gray-600">
        <div>
          <a class="whitespace-nowrap text-gray-700 hover:text-gray-900">TWH</a>
        </div>
        <div class="flex items-center ml-1 whitespace-nowrap">
          <mat-icon class="fuse-horizontal-navigation-item-icon text-gray-400" [svgIcon]="'heroicons_solid:chevron-right'"></mat-icon>
          <a class="ml-1 text-gray-700 hover:text-gray-900">B2B</a>
        </div>
        <div class="flex items-center ml-1 whitespace-nowrap">
          <mat-icon class="fuse-horizontal-navigation-item-icon text-gray-400" [svgIcon]="'heroicons_solid:chevron-right'"></mat-icon>
          <a class="ml-1 text-gray-700 hover:text-gray-900">Ordenes de Salida</a>
        </div>
      </div>
      <div class="mt-1">
        <h2 class="text-3xl md:text-4xl font-semibold tracking-tight leading-7 sm:leading-10 truncate text-gray-900">
          Generar Orden de Salida
        </h2>
      </div>
    </div>
  </div>

  <!-- Filtros -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 m-4 overflow-hidden">
    <div class="bg-gray-800 text-white px-4 py-2.5 border-b border-gray-700">
      <h3 class="text-base font-semibold text-gray-100">Filtros de Búsqueda</h3>
    </div>
    <div class="p-4">
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Propietario -->
        <div class="flex flex-col">
          <label for="propietario" class="text-xs font-medium text-gray-700 mb-1">Propietario:</label>
          <p-dropdown
            name="clientes"
            [options]="clientes"
            [(ngModel)]="model.PropietarioId"
            [filter]="true"
            filterBy="label"
            [showClear]="true"
            [style]="{ width: '100%' }"
            appendTo="body"
            [resetFilterOnHide]="false"
            [hideTransitionOptions]="'0ms'"
            [showTransitionOptions]="'0ms'"
            placeholder="Seleccione un propietario"
            styleClass="text-sm border-gray-300">
            <ng-template let-item pTemplate="selectedItem">
              <span style="vertical-align: left">{{ item.label }}</span>
            </ng-template>
          </p-dropdown>
        </div>

        <!-- Fecha Inicio -->
        <div class="flex flex-col">
          <label for="dateInicio" class="text-xs font-medium text-gray-700 mb-1">Fec. Inicio</label>
          <p-calendar
            id="dateInicio"
             appendTo="body"
            [(ngModel)]="dateInicio"
            dateFormat="dd.mm.yy"
            styleClass="text-sm border-gray-300"
          />
        </div>

        <!-- Fecha Fin -->
        <div class="flex flex-col">
          <label for="dateFin" class="text-xs font-medium text-gray-700 mb-1">Fec. Fin</label>
          <p-calendar
            id="dateFin"
             appendTo="body"
            [(ngModel)]="dateFin"
            dateFormat="dd.mm.yy"
            styleClass="text-sm border-gray-300"
          />
        </div>

        <!-- Nro Guía -->
        <div class="flex flex-col">
          <label class="text-xs font-medium text-gray-700 mb-1">Nro Guía:</label>
          <input
            pInputText
            minlength="5"
            maxlength="50"
            class="w-full text-sm border-gray-300"
            autocomplete="off"
            [(ngModel)]="model.guiaremision"
            name="guiaremision"
            #guiaremision="ngModel"
            type="text"
            placeholder="Número de guía"
          />
        </div>
      </div>

      <!-- Botones de Acción -->
      <div class="flex flex-wrap gap-2 mt-4 pt-4 border-t border-gray-200">
        <button
          class="px-4 py-2 text-sm font-medium text-white bg-gray-700 hover:bg-gray-600 rounded-md shadow-sm transition-all duration-150"
          pButton
          icon="fa fa-search"
          label="Buscar"
          iconPos="left"
          (click)="buscar()">
        </button>
        <button
          class="px-4 py-2 text-sm font-medium text-white bg-amber-600 hover:bg-amber-700 rounded-md shadow-sm transition-all duration-150"
          icon="fa fa-plus"
          pButton
          label="Nuevo"
          iconPos="left"
          (click)="nuevaorden()">
        </button>
      </div>
    </div>
  </div>

  <!-- Tabla de Órdenes -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 mx-4 mb-4 overflow-hidden">
    <div class="bg-gray-800 text-white px-4 py-2.5 border-b border-gray-700">
      <h3 class="text-base font-semibold text-gray-100">Listado de Órdenes de Salida</h3>
      <p class="text-xs text-amber-300 mt-1">Total de órdenes: {{ ordenes.length }}</p>
    </div>
    <div class="p-4">
      <p-table
        [style]="{ width: '100%' }"
        [scrollable]="true"
        scrollHeight="600px"
        [columns]="cols"
        [value]="ordenes"
        [(selection)]="selectedRow"
        #dt
        [paginator]="true"
        [rows]="10"
        selectionMode="multiple"
        [responsive]="true"
        [tableStyle]="{ 'table-layout': 'fixed', width: '100%' }"
        styleClass="p-datatable-sm"
      >
        <!-- Encabezados -->
        <ng-template pTemplate="colgroup" let-columns>
          <colgroup>
            <col
              *ngFor="let col of columns"
              [ngStyle]="{ width: col.width }"
            />
          </colgroup>
        </ng-template>

        <ng-template pTemplate="header" let-columns>
          <tr class="bg-gray-800 text-white">
            <th
              *ngFor="let col of columns"
              [ngStyle]="{ width: col.width }"
              pResizableColumn
              [pSortableColumn]="col.field"
              class="text-center px-4 py-2 text-sm font-semibold text-white border-b border-gray-700"
            >
              {{ col.header }}
              <p-sortIcon [field]="col.field"></p-sortIcon>
            </th>
          </tr>
        </ng-template>

        <!-- Cuerpo -->
        <ng-template pTemplate="body" let-rowData let-columns="columns">
          <tr [pSelectableRow]="rowData" class="border-b border-gray-100 hover:bg-gray-50 transition-colors duration-150">
            <!-- Acciones -->
            <td class="text-center px-4 py-2">
              <div class="flex flex-wrap justify-center gap-1">
                <p-button
                  severity="primary"
                  icon="fa fa-edit"
                  [disabled]="rowData.nombreEstado !== 'Creado'"
                  (click)="edit(rowData.ordenSalidaId)"
                  [size]="small"
                  [raised]="true"
                ></p-button>

                <p-button
                  severity="danger"
                  icon="fa fa-trash"
                  (click)="delete(rowData.ordenSalidaId)"
                  [disabled]="rowData.nombreEstado !== 'Creado'"
                  [size]="small"
                  [raised]="true"
                >
                </p-button>

                <p-button
                  severity="secondary"
                  icon="fa fa-search"
                  (click)="ver(rowData.ordenSalidaId)"
                  [size]="small"
                  [raised]="true"
                ></p-button>

                <!-- Botón Planificar (solo si está 'Creado') -->
                <p-button
                  *ngIf="rowData.nombreEstado === 'Creado'"
                  icon="pi pi-calendar-plus"
                  class="btn-planificar"
                  (click)="planificar(rowData)"
                  [size]="small"
                  [raised]="true"
                  severity="info"
                >
                </p-button>
              </div>
            </td>

            <!-- Otras columnas -->
            <td class="text-center px-4 py-2 text-gray-700 text-sm">{{ rowData.numOrden }}</td>

            <!-- Columna con color según estado -->
            <td class="text-center px-4 py-2">
              <span
                class="estado-badge inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                [ngClass]="getEstadoClass(rowData.nombreEstado)"
              >
                {{ rowData.nombreEstado }}
              </span>
            </td>

            <td class="text-center px-4 py-2 text-gray-700 text-sm">{{ rowData.guiaRemision || '-' }}</td>
            <td class="text-center px-4 py-2 text-gray-700 text-sm">{{ rowData.ordenCompraCliente || '-' }}</td>
            <td
              class="text-center px-4 py-2 text-sm"
              [ngClass]="
                rowData.tipoRegistro === 'CLIENTE'
                  ? 'text-blue-700 font-medium'
                  : 'text-gray-700'
              "
            >
              {{ rowData.usuarioregistro }}
            </td>
            <td class="text-center px-4 py-2 text-gray-700 text-sm">{{ rowData.fechaRequerida | date: 'dd/MM/yyyy' }}</td>
            <td class="text-center px-4 py-2 text-gray-700 text-sm">{{ rowData.fechaRegistro | date: 'dd/MM/yyyy' }}</td>
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
            <td [attr.colspan]="cols.length" class="text-center p-8">
              <div class="flex flex-col items-center">
                <i class="pi pi-inbox text-4xl mb-3 text-gray-300"></i>
                <span class="text-gray-500 text-sm">No hay órdenes disponibles</span>
                <span class="text-gray-400 text-xs mt-1">Use los filtros para buscar órdenes o cree una nueva</span>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>

  <!-- Dialog de Detalle -->
  <p-dialog
    header="Detalle de Orden de Salida"
    [(visible)]="detalleOrdenModal"
    [modal]="true"
    [style]="{ width: '80vw' }"
    [baseZIndex]="10000"
    styleClass="p-fluid"
  >
    <ng-template pTemplate="content">
      <div *ngIf="loadingDetalle" class="p-5 text-center">
        <i class="pi pi-spin pi-spinner text-2xl text-gray-400"></i>
        <p class="mt-2 text-gray-500">Cargando detalle...</p>
      </div>

      <div *ngIf="!loadingDetalle && detalleProductos?.length > 0">
        <p-table
          [value]="detalleProductos"
          [paginator]="true"
          [rows]="10"
          [responsive]="true"
          [scrollable]="true"
          [style]="{ width: '100%' }"
          styleClass="p-datatable-sm"
        >
          <ng-template pTemplate="header">
            <tr class="bg-gray-800 text-white">
              <th class="text-center px-4 py-2 text-sm font-semibold text-white border-b border-gray-700" style="width: 120px">Código</th>
              <th class="text-center px-4 py-2 text-sm font-semibold text-white border-b border-gray-700">Descripción</th>
              <th class="text-center px-4 py-2 text-sm font-semibold text-white border-b border-gray-700" style="width: 100px">Cantidad</th>
              <th class="text-center px-4 py-2 text-sm font-semibold text-white border-b border-gray-700" style="width: 100px">Unidad</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-row>
            <tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors duration-150">
              <td class="text-center px-4 py-2 text-gray-700 text-sm">{{ row.codigo }}</td>
              <td class="px-4 py-2 text-gray-700 text-sm">{{ row.producto }}</td>
              <td class="text-center px-4 py-2 text-amber-700 text-sm font-medium">{{ row.cantidad }}</td>
              <td class="text-center px-4 py-2 text-gray-700 text-sm">{{ row.unidadMedida }}</td>
            </tr>
          </ng-template>
        </p-table>
      </div>

      <div
        *ngIf="!loadingDetalle && detalleProductos?.length === 0"
        class="p-8 text-center"
      >
        <div class="flex flex-col items-center">
          <i class="pi pi-inbox text-4xl mb-3 text-gray-300"></i>
          <span class="text-gray-500 text-sm">No hay productos asignados a esta orden.</span>
        </div>
      </div>
    </ng-template>

    <ng-template pTemplate="footer">
      <button
        class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 hover:bg-gray-50 rounded-md shadow-sm transition-all duration-150"
        pButton
        label="Cerrar"
        icon="pi pi-times"
        iconPos="left"
        (click)="detalleOrdenModal = false">
      </button>
    </ng-template>
  </p-dialog>

  <p-confirmDialog />
  <p-toast />
</div>
