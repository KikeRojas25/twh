<div class="flex flex-col flex-auto min-w-0 bg-gray-50">
  <!-- Header -->
  <div class="flex flex-col sm:flex-row flex-0 sm:items-center sm:justify-between p-6 sm:py-4 sm:px-10 border-b border-gray-200 bg-white shadow-sm">
    <div class="flex-1 min-w-0">
      <div class="flex flex-wrap items-center font-medium text-sm text-gray-600">
        <div>
          <a class="whitespace-nowrap text-gray-700 hover:text-gray-900">TWH</a>
        </div>
        <div class="flex items-center ml-1 whitespace-nowrap">
          <mat-icon class="fuse-horizontal-navigation-item-icon text-gray-400" [svgIcon]="'heroicons_solid:chevron-right'"></mat-icon>
          <a class="ml-1 text-gray-700 hover:text-gray-900">B2B</a>
        </div>
        <div class="flex items-center ml-1 whitespace-nowrap">
          <mat-icon class="fuse-horizontal-navigation-item-icon text-gray-400" [svgIcon]="'heroicons_solid:chevron-right'"></mat-icon>
          <a class="ml-1 text-gray-700 hover:text-gray-900">Nueva Orden de Salida</a>
        </div>
      </div>
      <div class="mt-1">
        <h2 class="text-3xl md:text-4xl font-semibold tracking-tight leading-7 sm:leading-10 truncate text-gray-900">
          Nueva Solicitud de Salida
        </h2>
        <p class="mt-1 text-sm text-gray-500">
          Complete los campos para registrar un nuevo pedido de salida.
        </p>
      </div>
    </div>
    <div class="flex items-center gap-2 mt-4 sm:mt-0">
      <button
        class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 hover:bg-gray-50 rounded-md shadow-sm transition-all duration-150"
        pButton
        type="button"
        label="Cancelar"
        icon="pi pi-times"
        iconPos="left"
        (click)="cancelar()">
      </button>
      <button
        class="px-4 py-2 text-sm font-medium text-white bg-amber-600 hover:bg-amber-700 rounded-md shadow-sm transition-all duration-150"
        pButton
        type="submit"
        form="formSalida"
        label="Guardar solicitud"
        icon="pi pi-save"
        iconPos="left">
      </button>
    </div>
  </div>

  <!-- Formulario -->
  <form
    [formGroup]="form"
    (ngSubmit)="registrar()"
    id="formSalida"
    class="p-6 space-y-6"
  >
    <!-- Panel 1: Datos Generales -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
      <div class="bg-gray-800 text-white px-4 py-2.5 border-b border-gray-700">
        <h3 class="text-base font-semibold text-gray-100">Datos Generales</h3>
      </div>
      <div class="p-4">
        <div class="grid grid-cols-1 gap-4 md:grid-cols-3">
          <!-- Orden de Compra -->
          <div class="flex flex-col">
            <label class="text-xs font-medium text-gray-700 mb-1">Orden de Compra Cliente:</label>
            <input
              pInputText
              formControlName="ordenCompraCliente"
              placeholder="Ej: OC-102233"
              autocomplete="off"
              class="w-full text-sm border-gray-300"
            />
          </div>

          <!-- Fecha Requerida -->
          <div class="flex flex-col">
            <label class="text-xs font-medium text-gray-700 mb-1">Fecha requerida:</label>
            <p-calendar
              formControlName="fechaRequerida"
              [showIcon]="true"
              dateFormat="yy-mm-dd"
              [style]="{ width: '100%' }"
              styleClass="text-sm border-gray-300"
            ></p-calendar>
          </div>

          <!-- Hora Requerida -->
          <div class="flex flex-col">
            <label class="text-xs font-medium text-gray-700 mb-1">Hora requerida (24h):</label>
            <p-calendar
              formControlName="horaRequerida"
              [timeOnly]="true"
              [style]="{ width: '100%' }"
              styleClass="text-sm border-gray-300"
            ></p-calendar>
          </div>

          <!-- Observaciones -->
          <div class="flex flex-col md:col-span-3">
            <label class="text-xs font-medium text-gray-700 mb-1">Observaciones:</label>
            <textarea
              pInputTextarea
              formControlName="observaciones"
              rows="2"
              placeholder="Ej: Entregar en horario de oficina."
              class="w-full text-sm border-gray-300"
            ></textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- Panel 2: Datos del Comprador -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
      <div class="bg-gray-800 text-white px-4 py-2.5 border-b border-gray-700">
        <h3 class="text-base font-semibold text-gray-100">Datos del Comprador</h3>
      </div>
      <div class="p-4">
        <div class="grid grid-cols-1 gap-4 md:grid-cols-4">
          <div class="relative flex flex-col">
            <label class="text-xs font-medium text-gray-700 mb-1">Documento (RUC/DNI):</label>
            <div class="flex items-center">
              <input
                pInputText
                formControlName="documento"
                placeholder="20654321876"
                autocomplete="off"
                (blur)="buscarClientePorDocumento()"
                class="flex-1 text-sm border-gray-300"
              />

              <!-- Indicador -->
              <ng-container *ngIf="estadoCliente === 'encontrado'">
                <i
                  class="pi pi-check-circle ml-2 cursor-pointer text-green-500"
                  pTooltip="Cliente encontrado"
                  tooltipPosition="top"
                ></i>
              </ng-container>

              <ng-container *ngIf="estadoCliente === 'no_encontrado'">
                <i
                  class="pi pi-exclamation-circle ml-2 cursor-pointer text-yellow-500"
                  pTooltip="Cliente no encontrado"
                  tooltipPosition="top"
                ></i>
              </ng-container>
            </div>
          </div>

          <div class="relative flex flex-col">
            <label class="text-xs font-medium text-gray-700 mb-1">Nombre / Razón Social:</label>
            <input
              pInputText
              formControlName="nombre"
              placeholder="Ej: Comercial ABC S.A.C."
              [readonly]="estadoCliente === 'encontrado'"
              class="w-full text-sm border-gray-300"
            />

            <!-- Botón para registrar nuevo cliente -->
            <button
              *ngIf="estadoCliente === 'no_encontrado'"
              pButton
              type="button"
              label="Registrar cliente"
              icon="pi pi-user-plus"
              class="p-button-sm p-button-text mt-1 self-end text-blue-600"
              (click)="abrirDialogNuevoCliente()"
            ></button>
          </div>

          <div class="relative flex flex-col">
            <label class="text-xs font-medium text-gray-700 mb-1">Contacto (*):</label>
            <input
              pInputText
              formControlName="contacto"
              placeholder="Nombre del contacto"
              class="w-full text-sm border-gray-300"
            />
          </div>

          <div class="relative flex flex-col">
            <label class="text-xs font-medium text-gray-700 mb-1">Teléfono (*):</label>
            <input
              pInputText
              formControlName="telefono"
              placeholder="999888777"
              class="w-full text-sm border-gray-300"
            />
          </div>
        </div>

        <div class="mt-4 grid grid-cols-1 gap-4 md:grid-cols-4">
          <div class="relative flex flex-col">
            <label class="text-xs font-medium text-gray-700 mb-1">Correo:</label>
            <input
              pInputText
              formControlName="correo"
              placeholder="compras@abc.com.pe"
              class="w-full text-sm border-gray-300"
            />
          </div>

          <div class="relative flex flex-col">
            <label class="text-xs font-medium text-gray-700 mb-1">Destino: (*)</label>
            <p-dropdown
              [options]="ubigeo"
              formControlName="iddestino"
              virtualScroll="true"
              [itemSize]="30"
              optionLabel="label"
              optionValue="value"
              filter="true"
              placeholder="Seleccione un destino"
              class="w-full"
              appendTo="body"
              styleClass="text-sm border-gray-300"
              [ngClass]="{
                'ng-invalid ng-dirty':
                  form.get('iddestino')?.touched &&
                  form.get('iddestino')?.invalid,
              }"
            >
              <ng-template let-item pTemplate="selectedItem">
                <span>{{ item.label }}</span>
              </ng-template>
            </p-dropdown>
          </div>

          <div class="flex flex-col md:col-span-2">
            <label class="text-xs font-medium text-gray-700 mb-1">Dirección de Entrega: (*)</label>
            <input
              pInputText
              formControlName="direccionEntrega"
              placeholder="Av. El Derby 123, Santiago de Surco"
              class="w-full text-sm border-gray-300"
            />
          </div>
        </div>
      </div>
    </div>

    <!-- Panel 3: Detalle del Pedido -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
      <div class="bg-gray-800 text-white px-4 py-2.5 border-b border-gray-700">
        <h3 class="text-base font-semibold text-gray-100">Detalle del Pedido</h3>
        <p class="text-xs text-amber-300 mt-1">Agregue los productos que desea incluir en la orden</p>
      </div>
      <div class="p-4">
        <div class="grid grid-cols-1 gap-6 lg:grid-cols-3">
          <!-- Columna Izquierda: Formulario para agregar ítem -->
          <div>
            <div class="bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden">
              <div class="bg-gray-100 px-4 py-2 border-b border-gray-200">
                <h4 class="text-sm font-semibold text-gray-800">Agregar nuevo ítem</h4>
              </div>
              <div class="p-4">
                <!-- Producto -->
                <label class="block text-xs font-medium text-gray-700 mb-1">Producto</label>
                <p-autoComplete
                  [(ngModel)]="model.productoSeleccionado"
                  [suggestions]="productosFiltrados"
                  [ngModelOptions]="{ standalone: true }"
                  (completeMethod)="buscarProductos($event)"
                  [minLength]="2"
                  appendTo="body"
                  [delay]="300"
                  [field]="'nombreCompleto'"
                  [dropdown]="true"
                  [forceSelection]="true"
                  [style]="{ width: '100%' }"
                  styleClass="text-sm border-gray-300"
                >
                  <ng-template let-item pTemplate="item">
                    <div class="flex items-center justify-between">
                      <span>{{ item.nombreCompleto }}</span>
                      <small class="text-gray-500">({{ item.unidad }})</small>
                    </div>
                  </ng-template>

                  <ng-template let-item pTemplate="selectedItem">
                    <div>{{ item.nombreCompleto }}</div>
                  </ng-template>
                </p-autoComplete>

                <!-- Enlace para ver stock -->
                <div class="mt-1 text-right">
                  <a
                    class="cursor-pointer text-xs text-blue-600 hover:underline"
                    (click)="verStock()"
                    *ngIf="model.productoSeleccionado"
                  >
                    Ver stock disponible
                  </a>
                </div>

                <!-- Cantidad -->
                <div class="mt-3">
                  <label class="block text-xs font-medium text-gray-700 mb-1">Cantidad</label>
                  <input
                    pInputText
                    type="number"
                    [ngModelOptions]="{ standalone: true }"
                    min="1"
                    [(ngModel)]="model.cantidad"
                    class="w-full text-sm border-gray-300"
                  />
                </div>

                <!-- Lote -->
                <div class="mt-3">
                  <label class="block text-xs font-medium text-gray-700 mb-1">Lote (opcional)</label>
                  <input
                    pInputText
                    type="text"
                    [ngModelOptions]="{ standalone: true }"
                    [(ngModel)]="model.lote"
                    class="w-full text-sm border-gray-300"
                  />
                </div>

                <!-- Referencia -->
                <div class="mt-3">
                  <label class="block text-xs font-medium text-gray-700 mb-1">Referencia (opcional)</label>
                  <input
                    pInputText
                    type="text"
                    [ngModelOptions]="{ standalone: true }"
                    [(ngModel)]="model.referencia"
                    class="w-full text-sm border-gray-300"
                  />
                </div>

                <!-- Botón -->
                <div class="mt-4">
                  <button
                    class="w-full px-3 py-1.5 text-xs font-medium text-white bg-amber-600 hover:bg-amber-700 rounded-md shadow-sm transition-all duration-150"
                    pButton
                    label="Agregar ítem"
                    type="button"
                    icon="pi pi-plus"
                    iconPos="left"
                    (click)="agregarItem()">
                  </button>
                </div>
              </div>
            </div>

            <!-- Diálogo de stock -->
            <p-dialog
              header="Stock Disponible"
              [(visible)]="dialogStockVisible"
              [modal]="true"
              [closable]="true"
              [style]="{ width: '400px' }"
              styleClass="p-fluid"
            >
              <div *ngIf="stockInfo; else cargandoStock" class="space-y-2">
                <p class="text-sm">
                  <strong class="text-gray-700">Producto:</strong>
                  <span class="text-gray-900">{{ stockInfo.codigo }}</span>
                </p>
                <p class="text-sm">
                  <strong class="text-gray-700">Descripción:</strong>
                  <span class="text-gray-900">{{ stockInfo.descripcionLarga }}</span>
                </p>
                <p class="text-sm">
                  <strong class="text-gray-700">Stock disponible:</strong>
                  <span class="text-amber-700 font-medium">{{ stockInfo.stockDisponibleTotal }} {{ stockInfo.unidadAlmacenamiento }}</span>
                </p>
                <p class="text-sm">
                  <strong class="text-gray-700">Estado:</strong>
                  <span class="text-gray-900">{{ stockInfo.estado }}</span>
                </p>
              </div>

              <ng-template #cargandoStock>
                <div class="text-center text-gray-500 py-4">
                  <i class="pi pi-spin pi-spinner mr-2"></i>
                  Consultando stock...
                </div>
              </ng-template>
            </p-dialog>
          </div>

          <!-- Columna Derecha: Tabla de detalle -->
          <div class="lg:col-span-2">
            <p-table
              [value]="detalle"
              dataKey="codigo"
              class="w-full"
              styleClass="p-datatable-sm"
              [scrollable]="true"
              scrollHeight="400px"
            >
              <ng-template pTemplate="header">
                <tr class="bg-gray-800 text-white">
                  <th class="text-center px-4 py-2 text-sm font-semibold text-white border-b border-gray-700" style="width: 120px">Código</th>
                  <th class="text-center px-4 py-2 text-sm font-semibold text-white border-b border-gray-700">Descripción</th>
                  <th class="text-center px-4 py-2 text-sm font-semibold text-white border-b border-gray-700" style="width: 100px">Cantidad</th>
                  <th class="text-center px-4 py-2 text-sm font-semibold text-white border-b border-gray-700" style="width: 100px">Unidad</th>
                  <th class="text-center px-4 py-2 text-sm font-semibold text-white border-b border-gray-700" style="width: 80px">Acciones</th>
                </tr>
              </ng-template>

              <ng-template pTemplate="body" let-row let-i="rowIndex">
                <tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors duration-150">
                  <td class="text-center px-4 py-2 text-gray-700 text-sm">{{ row.codigo }}</td>
                  <td class="px-4 py-2 text-gray-700 text-sm">{{ row.descripcion }}</td>
                  <td class="text-center px-4 py-2 text-amber-700 text-sm font-medium">{{ row.cantidad }}</td>
                  <td class="text-center px-4 py-2 text-gray-700 text-sm">{{ row.unidadMedida }}</td>
                  <td class="text-center px-4 py-2">
                    <button
                      pButton
                      icon="pi pi-trash"
                      (click)="eliminarFila(i)"
                      class="p-button-sm p-button-danger"
                      type="button"
                      [size]="small"
                      [raised]="true"
                    ></button>
                  </td>
                </tr>
              </ng-template>

              <ng-template pTemplate="emptymessage">
                <tr>
                  <td [attr.colspan]="5" class="text-center p-8">
                    <div class="flex flex-col items-center">
                      <i class="pi pi-inbox text-4xl mb-3 text-gray-300"></i>
                      <span class="text-gray-500 text-sm">No hay productos agregados aún</span>
                      <span class="text-gray-400 text-xs mt-1">Use el formulario a la izquierda para agregar productos</span>
                    </div>
                  </td>
                </tr>
              </ng-template>
            </p-table>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>

<p-confirmDialog />
<p-toast />
